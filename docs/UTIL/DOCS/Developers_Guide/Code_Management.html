
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../../_static/CMAQ_Logo_2_inch.png" sizes="600x593" rel="icon" type="image/png">
    <title>Code Management and Development &#8212; CMAQ 5.5+ documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=eec9c716"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'DOCS/Developers_Guide/Code_Management';</script>
    <link rel="canonical" href="https://usepa.github.io/CMAQ/DOCS/Developers_Guide/Code_Management.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/CMAQ_Logo_2_inch.png" class="logo__image only-light" alt="CMAQ 5.5+ documentation - Home"/>
    <img src="../../_static/CMAQ_Logo_2_inch.png" class="logo__image only-dark pst-js-only" alt="CMAQ 5.5+ documentation - Home"/>
  
  
</a></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/USEPA/CMAQ" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.epa.gov/cmaq" title="CMAQ - EPA Site" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/epa_seal_w-ring_RGB-sm.png" class="icon-link-image" alt="CMAQ - EPA Site"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forum.cmascenter.org/" title="User Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/cmas_logo.png" class="icon-link-image" alt="User Forum"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://usepa.github.io/CRACMM/" title="CRACMM" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/CRACMM_1.png" class="icon-link-image" alt="CRACMM"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/CMAQ_Logo_2_inch.png" class="logo__image only-light" alt="CMAQ 5.5+ documentation - Home"/>
    <img src="../../_static/CMAQ_Logo_2_inch.png" class="logo__image only-dark pst-js-only" alt="CMAQ 5.5+ documentation - Home"/>
  
  
</a></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/USEPA/CMAQ" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://www.epa.gov/cmaq" title="CMAQ - EPA Site" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/epa_seal_w-ring_RGB-sm.png" class="icon-link-image" alt="CMAQ - EPA Site"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forum.cmascenter.org/" title="User Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/cmas_logo.png" class="icon-link-image" alt="User Forum"/></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://usepa.github.io/CRACMM/" title="CRACMM" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/CRACMM_1.png" class="icon-link-image" alt="CRACMM"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Getting_Started.html">Getting Started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Users_Guide/README.html">CMAQ User’s Guide</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch01_overview.html">1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch02_program_structure.html">2. Program Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch03_preparing_compute_environment.html">3. Preparing Compute Environment for CMAQ Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch04_model_inputs.html">4. Model Input Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch05_running_a_simulation.html">5. Running a CMAQ Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch06_model_configuration_options.html">6. Model Configuration Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch07_model_outputs.html">7. Model Output Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch08_analysis_tools.html">8. Analysis Tools for CMAQ output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch09_process_analysis.html">9. Process Analysis and Budget</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch10_HDDM-3D.html">10. Decoupled Direct Method in Three Dimensions (CMAQ-DDM-3D)</a></li>




<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch11_ISAM.html">11. Integrated Source Apportionment Method (CMAQ-ISAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch12_sulfur_tracking.html">12. Sulfur Tracking Method</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch13_WRF-CMAQ.html">13. WRF-CMAQ Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/CMAQ_UG_ch14_MPAS-CMAQ.html">14. MPAS-CMAQ Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/Appendix/README.html">Appendix</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Users_Guide/Tutorials/README.html">CMAQ Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/Tutorials/CMAQ_UG_tutorial_configure_linux_environment.html">Configuring your compute environment for CMAQ simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Users_Guide/Tutorials/CMAQ_UG_tutorial_running_benchmarks.html">CMAQ Benchmark Tutorials</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Release_Notes/README.html">Release Notes</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Instrumented-Models.html">Instrumented Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-MPAS-CMAQ-Coupled-Model.html">MPAS-CMAQ Coupled Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-WRF-CMAQ-Coupled-Model.html">WRF-CMAQ Coupled Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Chemistry.html">Chemistry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Transport-Processes.html">Transport Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Dry-Deposition-Air-Surface-Exchange.html">Dry Deposition/Air-Surface Exchange</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Emissions-Updates.html">Emissions Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Process-Analysis-%26-Sulfur-Tracking-Model-%28STM%29.html">Process Analysis &amp; STM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Structural-Improvements.html">Structural Improvements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Diagnostic-Options.html">Diagnostic Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Preprocessors.html">Pre-processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-PYTOOLS.html">PYTOOLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Postprocessors.html">Post-processors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Utilities.html">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_Notes/CMAQ-Release-Notes%3A-Stratospheric%E2%80%90Tropospheric-Exchange-%28STE%29.html">Stratospheric-Tropospheric Exchange (STE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CMAQ-Bugfix-Branch.html">Bug fix branch</a></li>

</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Release_FAQ/README.html">FAQs</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Release_FAQ/CMAQv5.5-Series-FAQ.html">FAQ v5.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Release_FAQ/CMAQv5.4-Series-FAQ.html">FAQ v5.4</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../Community_Support.html">Community Support</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Code Management and Development</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="code-management-and-development">
<h1>Code Management and Development<a class="headerlink" href="#code-management-and-development" title="Link to this heading">#</a></h1>
<p>As a public domain model, CMAQ is the product of contributions from many developers, whose numbers are only expected to increase with the number of users worldwide. Some degree of standardization is necessary for management and archiving of these development versions, as well as to compile and execute the code once it is ready for use, and to submit it to the CMAS Center for archiving and benchmark testing. This chapter provides guidance on source code manage­ment, coding guidelines for new code development, the compilation of new source code using the build scripts, and guidelines for writing shell scripts usable by CMAQ. Much of this informa­tion is derived from Chapter 18 (Young, 1999) in Byun and Ching (1999), with updates where appropriate, particularly for new versions of the model code and for the Fortran 90 standard. The chapter also includes the procedure that is in place for distributing code versions other than the operational CMAQ that are submitted to the development code archives.</p>
<section id="source-code-management">
<h2>Source Code Management<a class="headerlink" href="#source-code-management" title="Link to this heading">#</a></h2>
<section id="the-need-for-a-configuration-management-tool">
<h3>The need for a configuration-management tool<a class="headerlink" href="#the-need-for-a-configuration-management-tool" title="Link to this heading">#</a></h3>
<p>Faced with a large and growing community that uses and develops a wide variety of programs, modules, and codes, it is imperative to systematically manage the cross-community access to this software. Typically, successful management of software involves the following:</p>
<ul class="simple">
<li><p>A repository – a place where all of the public code resides.</p></li>
<li><p>The concept of archived code – codes that have been deposited into the repository in such a manner that anyone can extract the exact code at a later time. This involves some kind of transformation program to maintain master copies of the codes with embedded change tables.</p></li>
<li><p>The concept of revision control – archiving codes results in modifying the tags or unique revision identifiers in the change tables in the master copies in order to recover the exact code at a later date.</p></li>
<li><p>The concept of released code – codes that have reached some state of maturity and have been designated with some kind of “released” status. They can be used with reasonable expectation of reliability. The paradigm used employs the following scenario:</p>
<ol class="arabic simple">
<li><p>A user modifies or develops code. The code may be one subroutine or many, possibly constituting whole science modules. The code may originate from “scratch,” or be extracted from the repository and modified.</p></li>
<li><p>After testing or reaching a point of being satisfied with his/her results, he/she decides to save it in the repository so that others can have access to it.</p></li>
<li><p>Some archived codes may still be in an experimental, or development, state, while others may be reasonably stable and more completely tested. The latter may be designated as “released.” There is no enforceable means to control access based on an experimental or released state. The community will have, and should have, access indiscriminately, well aware that using development-state code is risky.</p></li>
<li><p>As the user continues to work with the codes, he/she may make enhancements or discover and fix errors. The upgrades are then installed in the repository, which automatically assigns unique revision identifiers.</p></li>
<li><p>The repository is located where it is conveniently accessible to all users, and is maintained by an administrator who sets and enforces general access rules.</p></li>
</ol>
</li>
</ul>
</section>
<section id="choice-of-a-configuration-management-tool">
<h3>Choice of a configuration-management tool<a class="headerlink" href="#choice-of-a-configuration-management-tool" title="Link to this heading">#</a></h3>
<p>Prior to CMAQ version 5.0.2, CMAQ developers used <a class="reference external" href="https://en.wikipedia.org/wiki/Concurrent_Versions_System" rel="noreferrer" target="_blank">CVS <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a> for versioning, and distributed tarballs included CVS artifacts (e.g., files with names ending with ‘,v’). Starting with version 5.0.2, CMAQ developers switched to <a class="reference external" href="https://en.wikipedia.org/wiki/Git_%28software%29" rel="noreferrer" target="_blank">git <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a>.</p>
</section>
<section id="git-explained">
<h3>git Explained<a class="headerlink" href="#git-explained" title="Link to this heading">#</a></h3>
<p>git is a version control system that supports distributed workflows.  Every Git directory is a full repository with complete history and version tracking.</p>
<ul>
<li><p>It works on virtually all UNIX and Linux platforms and on many PCs.</p></li>
<li><p>It is publicly available and free and is distributed under the terms of the GNU General Public License.</p></li>
<li><p>If you would like to contribute changes to the EPA CMAQ repository, use the following steps</p>
<ol class="arabic">
<li><p>Create a github account https://github.com/</p></li>
<li><p>Go to the EPA github site and Fork your own copy of the EPA CMAQ to your github account</p></li>
<li><p>create a directory called CMAQv5.3 on the machine where you would like to obtain a copy of the code</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">-b</span> <span class="pre">main</span> <span class="pre">https://github.com/&lt;your</span> <span class="pre">github</span> <span class="pre">name&gt;/CMAQ.git</span> <span class="pre">CMAQ_REPO</span></code> - Get a clone or copy of the main branch of the CMAQ repository from your github site.</p></li>
<li><p>This will place a copy of the files from the main branch into the CMAQv5.3/CMAQ_REPO directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">CMAQv5.3/CMAQ_REPO</span></code> go into the CMAQv5.3/CMAQ_REPO directory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">status</span></code>   To confirm the status of the files in the repository and the branch that is currently checked out</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">-b</span> <span class="pre">5.3_update</span></code> To copy the 5.3 branch into a new branch called 5.3_update</p></li>
<li><p>To edit the config_cmaq.csh file take the following steps:<br>
<code class="docutils literal notranslate"><span class="pre">vi</span> <span class="pre">config_cmaq.csh</span></code>  - or use the Atom, TextWrangler or other Editor</p></li>
<li><p>To see what changes you made use the following command
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">diff</span> <span class="pre">config_cmaq.csh</span></code></p></li>
<li><p>To stage the change use the following command.
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span> <span class="pre">config_cmaq.csh</span></code></p></li>
<li><p>To commit changes to the local repostitory use the command:
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">-m</span> <span class="pre">&quot;changed</span> <span class="pre">config_cmaq.csh</span> <span class="pre">to</span> <span class="pre">fix</span> <span class="pre">issue</span> <span class="pre">X&quot;</span></code></p></li>
<li><p>To commit changes to your Github repository on the branch 5.3_update use the command:
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code></p></li>
<li><p>If you get a message that the push was rejected similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! [rejected]        5.3_update -&gt; 5.3_update (fetch first)
  error: failed to push some refs to &#39;https://github.com/CEMPD/CMAQ.git&#39;
  hint: Updates were rejected because the remote contains work that you do
  hint: not have locally. This is usually caused by another repository pushing
  hint: to the same ref. You may want to first integrate the remote changes
  hint: (e.g., &#39;git pull ...&#39;) before pushing again.
 hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.
</pre></div>
</div>
</li>
<li><p>This means the files have been changed on your Github repository since you last did a clone.
Use the following command to get the changes that have been made to the remote git repository:
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code></p></li>
<li><p>You will be asked to merge the files if there are no changes that conflict with your file changes. IF successful you will see a message similar to the following, that indicates what files were changed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Merge</span> <span class="n">made</span> <span class="n">by</span> <span class="n">the</span> <span class="s1">&#39;recursive&#39;</span> <span class="n">strategy</span><span class="o">.</span>
<span class="n">config_cmaq</span><span class="o">.</span><span class="n">csh</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">++--</span>
<span class="mi">1</span> <span class="n">file</span> <span class="n">changed</span><span class="p">,</span> <span class="mi">2</span> <span class="n">insertions</span><span class="p">(</span><span class="o">+</span><span class="p">),</span> <span class="mi">2</span> <span class="n">deletions</span><span class="p">(</span><span class="o">-</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Retry the push command to place the changes that you committed to the local repository on your Github repository:
<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code></p></li>
<li><p>Go to your github page and use the Compare link to the right of the Pull Request link to see what changes you are proposing to make as compared to what is on the base repository: USEPA/CMAQ. Review your proposed code changes in the github “Comparing Changes” page.</p></li>
<li><p>Create a pull request to ask that the changes that you have made be incorporated into the EPA github site.</p></li>
</ol>
</li>
</ul>
</section>
</section>
<section id="guidelines-for-developing-new-cmaq-source-code">
<h2>Guidelines for Developing New CMAQ Source Code<a class="headerlink" href="#guidelines-for-developing-new-cmaq-source-code" title="Link to this heading">#</a></h2>
<section id="object-oriented-concepts">
<h3>Object-oriented concepts<a class="headerlink" href="#object-oriented-concepts" title="Link to this heading">#</a></h3>
<p>To make the CMAQ system robust and flexible, object-oriented concepts were incorporated into the design of the system. The incorporation of these ideas helps developers avoid introducing errors when code modifications are needed. Additionally, the system can easily and efficiently be modified, allowing the user to quickly create models for different applications. The implemen­tation language for CMAQ is Fortran 90, which imposes limits on how far one can go in terms of object-oriented design. In particular, because Fortran is a static language, objects cannot be instantiated dynamically; they must be declared explicitly in the source code to be created at compile time. However, to encourage a user community that will be contributing code for future enhancements, every attempt has been made to adhere to the Fortran 90 standard.</p>
</section>
<section id="global-name-data-table">
<h3>Global name data table<a class="headerlink" href="#global-name-data-table" title="Link to this heading">#</a></h3>
<p>To implement modularity and data independence, we have employed design ideas that draw heavily from the object-oriented concept of ‘’inheritance ‘’and code re-use. The data structures in the codes that deal with the chemical mechanism, I/O API, logical file names, general constants, and pointers are determined by Fortran declarations in data and parameter statements in the CMAQ system. These data structures pertain to a particular application and are meant to apply globally—not just to one particular CCTM through all its subroutines, but also to all the models that supply data to CCTM for that application. These data structures are contained in Fortran INCLUDE files, which are essentially header files, included in the declaration sections near the top of the Fortran code source files. The inclusion of these source files is made automatic by using a generic string that represents the INCLUDE file and that is parsed and expanded to the actual INCLUDE file during a preprocessing stage in the compilation. The Fortran global INCLUDE files contain name tables that define:</p>
<ol class="arabic simple">
<li><p>The chemical mechanism;</p></li>
<li><p>The I/O API interface, including logical file names;</p></li>
<li><p>The global modeling constants; and</p></li>
<li><p>Other constants or parameters that apply across the model.</p></li>
</ol>
<p>To effect the implementation of the INCLUDE files into the code, a special compiling system, Bldmake, was developed (Fine et al., 1998), which reads a configuration file that, based on the application, completely determines the model executable to be built. The ASCII configuration file can be generated either by the CMAQ system or by the users following a few, simple syntactical rules. In addition to the global INCLUDE files, the configuration file contains module commands that tell Bldmake to extract the codes for that module from the model code repository for compilation.</p>
</section>
<section id="thin-interface">
<h3>Thin Interface<a class="headerlink" href="#thin-interface" title="Link to this heading">#</a></h3>
<p>As mentioned in <a class="reference internal" href="#CMAQ_OGD_ch04_science.md#modular-flexibility"><span class="xref myst">Chapter 4</span></a>, CMAQ is designed to be robust and flexible with respect to the interchange of modules and the elimination of cross-module data dependencies. Consequently, the concept of a “thin interface” has been employed in the design, which applies principally to the class-drivers (i.e. the top level call to a science module). At a minimum, the thin interface implementation implies the following requirements:</p>
<ul class="simple">
<li><p>Eliminate global memory references (across modules). This implies no common blocks across modules, no hidden data paths, and no “back doors.”</p></li>
<li><p>Each module reads and interpolates its required data independently. The I/O API helps to ensure this kind of data independence.</p></li>
<li><p>Standardized argument list (CGRID, Date, Time, TimeStep) for calling the class-driver. See the example in Section 9.2.6. These requirements attempt to incorporate the object-oriented idea of encapsulation in the CMAQ design. Rumbaugh et al. (1991) suggest that “Encapsulation (also information hiding) consists of separating the external aspects of an object, which are accessible to other objects, from the internal implementation details of the object, which are hidden from other objects. Encapsulation prevents a program from becoming so interdependent that a small change has massive ripple effects. The implementation’’ ‘’of an object can be changed without affecting the applications that use it.”</p></li>
</ul>
<p>The encapsulation design makes the CMAQ system safer and enables the transaction processing, plug-and-play capability. This design also makes it easier for a user to trace data and usage within a module, particularly at the class-driver level.</p>
</section>
<section id="coding-guidelines">
<h3>Coding guidelines<a class="headerlink" href="#coding-guidelines" title="Link to this heading">#</a></h3>
<p>To maintain the object-oriented concepts implemented in the CMAQ system design, we have established a small set of coding guidelines that apply to those who develop CMAQ science modules and affect the low-level design of the models. We have developed standards to control data dependencies at the class-driver level, but we have not propagated these coding standards to the submodule level.</p>
<ol class="arabic simple">
<li><p>The models are generally coded in Fortran (both Fortran 90 and Fortran 77 conventions are used by various developers). It is possible to link in subroutines written in the C language, although this has not been done within the current CMAQ implementation. While the Fortran 90 compiler will compile Fortran 77 code, the reverse is not true. Thus the Makefiles are set up to invoke the Fortran 90 compiler.</p></li>
<li><p>To enable code compatibility between the Fortran 77 compiler and Fortran 90 code, the following guidance is provided: Line length beyond 72 characters is permissible in Fortran 90 (with line continuation indicated by an ending ‘&amp;’), but not in Fortran 77; therefore, insertion of the ‘&amp;’ in column 73 of the first line and in column 6 of the next line of the Fortran 90 code will ensure compatibility with both compilers (the ‘&amp;’ at the beginning of a line is “in principle” ignored by the Fortran 90 compiler, but interpreted as a continuation character by the Fortran 77 compiler if it appears in column 6).</p></li>
<li><p>The modules must be controlled by a top-level class-driver routine, whose calling arguments must be the computational concentration grid array (CGRID), the current scenario date (Date), scenario time (Time), and the controlling time step vector (TimeStep). (See Section 9.2.3 above.)</p></li>
<li><p>The class-driver is also responsible for any temporal integration required within the module. (The time steps for process integration at the module level are usually shorter than those of the CCTM synchronization time step.)</p></li>
<li><p>Any reads and writes for the module should be done at the level of the class-driver routine. Although not absolutely necessary, this is strongly suggested because it is usually much easier to control the timing of the data accesses at the highest level of the module where the current scenario date and time are known.</p></li>
<li><p>Use the Fortran declaration IMPLICIT NONE to maintain some control on typographic errors and undefined variables. The use of IMPLICIT NONE forces the developer to declare all internal variables. This is standard in Fortran 90.</p></li>
<li><p>Use the global INCLUDE files for chemical mechanism data, and other data where available.</p></li>
<li><p>Use the I/O API for external data references where appropriate. For an illustration of these rules, see the code template provided in Section 9.2.6.</p></li>
</ol>
<p>At the submodule level, there are no strict I/O or coding standards. Here it is envisioned that individual researchers/programmers use their own coding styles for their algorithms. However, the following suggestions are offered to facilitate the potential incorporation of a module into the CMAQ system:</p>
<ul class="simple">
<li><p>In general, it is expected that MKS units are used for input and output variables, as these units have been standardized throughout the CMAQ system. Within a submodule subroutine, whatever units are most convenient can be used. However, the developer must be responsible for any unit conversions to MKS for input and output, and thus avoid potential errors.</p></li>
<li><p>For efficiency and performance considerations, operations may need to be done on groups of grid cells (a block of cells) at a time. If there are N cells in the block and the entire domain contains M cells, then the entire domain can be decomposed into M/N blocks. The default value of N is set to 500. For operations in the horizontal (x,y), the cell constraint becomes X×Y≤N, where X = number of cells in the x-direction, and Y = number of cells in the y-direction. For operations in both the horizontal and vertical, the constraint becomes X×Y×Z≤N, where Z = number of cells in the z-direction. There may be some operations, such as for some horizontal advection schemes, where this decomposition into blocks becomes more difficult or impossible.</p></li>
</ul>
</section>
<section id="documentation-guidelines">
<h3>Documentation guidelines<a class="headerlink" href="#documentation-guidelines" title="Link to this heading">#</a></h3>
<p>Appropriate documentation is critical to the ease of use and maintainability of code developed for CMAQ. The official released version of CMAQ contains extensive in-line documentation and references to pertinent technical information whenever possible. Given the increasing number of new developers and code modules, the following guidelines are provided for new code developed for CMAQ:</p>
<ul class="simple">
<li><p>The code revision history should be initiated or updated as appropriate for new and modified code, indicating the author, date, and nature of the revision. The revision history appears at the top of the subroutine.</p></li>
<li><p>Complete references to the pertinent technical documents should be provided whenever possible, and listed in comment lines immediately following the revision history notes. They should be cited in comments preceding, or embedded in-line with, the relevant code segments.</p></li>
<li><p>In-line documentation of the variable definitions indicating units is highly recommended in both subroutines and INCLUDE files, to facilitate the correct implementation of any code modifications in the future. This information is generally included in comments embedded in-line with the declaration of each variable.</p></li>
</ul>
</section>
<section id="science-process-code-template">
<h3>Science process code template<a class="headerlink" href="#science-process-code-template" title="Link to this heading">#</a></h3>
<p>The following example from CMAQ v4.7 illustrates a science process class-driver Fortran 90 subroutine. Code developers should follow this template, where appropriate, to maximize the benefit from the design concepts implemented in CMAQ. This template is generic and demonstrates many of the available features. Some class drivers and most other subprograms within a module may not have, nor require, most or any of these features. (The numbers at the left-hand margin refer to footnotes and are not part of the code, and the text within “&lt; &gt;” indicates code removed from the example for brevity in this section)</p>
<p><strong>Example of Science Process Class-Driver</strong></p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="kd">::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><span class="p">:</span>
<span class="w">      </span><span class="k">SUBROUTINE </span><span class="n">VDIFF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CGRID</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>
<span class="n">C</span><span class="w"> </span><span class="n">Asymmetric</span><span class="w"> </span><span class="n">Convective</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="p">(</span><span class="n">ACM2</span><span class="p">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">Pleim</span><span class="p">(</span><span class="mi">2006</span><span class="p">)</span>
<span class="n">C</span><span class="w"> </span><span class="k">Function</span><span class="p">:</span>
<span class="n">C</span><span class="w">   </span><span class="n">calculates</span><span class="w"> </span><span class="nb">and </span><span class="n">writes</span><span class="w"> </span><span class="n">dry</span><span class="w"> </span><span class="n">deposition</span><span class="p">.</span>
<span class="n">C</span><span class="w">   </span><span class="n">calculates</span><span class="w"> </span><span class="n">vertical</span><span class="w"> </span><span class="n">diffusion</span>

<span class="n">C</span><span class="w"> </span><span class="n">Subroutines</span><span class="w"> </span><span class="nb">and </span><span class="n">Functions</span><span class="w"> </span><span class="n">Called</span><span class="p">:</span>
<span class="n">C</span><span class="w">   </span><span class="n">INIT3</span><span class="p">,</span><span class="w"> </span><span class="n">SEC2TIME</span><span class="p">,</span><span class="w"> </span><span class="n">TIME2SEC</span><span class="p">,</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">,</span><span class="w"> </span><span class="n">NEXTIME</span><span class="p">,</span>
<span class="n">C</span><span class="w">   </span><span class="n">M3EXIT</span><span class="p">,</span><span class="w"> </span><span class="n">EDDYX</span><span class="p">,</span><span class="w"> </span><span class="n">TRI</span><span class="p">,</span><span class="w"> </span><span class="n">MATRIX</span><span class="p">,</span><span class="w"> </span><span class="n">PA_UPDATE_EMIS</span><span class="p">,</span><span class="w"> </span><span class="n">PA_UPDATE_DDEP</span>
<span class="n">C</span><span class="w"> </span><span class="n">Revision</span><span class="w"> </span><span class="n">History</span><span class="p">:</span>
<span class="n">C</span><span class="w">   </span><span class="n">Analogous</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">VDIFFIM</span><span class="w"> </span><span class="p">(</span><span class="n">Eddy</span><span class="w"> </span><span class="n">diffusion</span><span class="w"> </span><span class="n">PBL</span><span class="w"> </span><span class="n">scheme</span><span class="p">)</span>
<span class="n">C</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="n">Mar</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">G</span><span class="p">.</span><span class="n">Sarwar</span><span class="p">:</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">halogen</span><span class="w"> </span><span class="n">emissions</span>
<span class="n">C</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">Sep</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">J</span><span class="p">.</span><span class="n">Young</span><span class="p">:</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">inline</span><span class="w"> </span><span class="n">procan</span><span class="w"> </span><span class="p">(</span><span class="n">IPR</span><span class="p">)</span>
<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>
<span class="p">...</span>
<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>

<span class="w">      </span><span class="k">USE </span><span class="n">CGRID_SPCS</span><span class="w">          </span><span class="c">! CGRID mechanism species</span>
<span class="w">      </span><span class="k">USE </span><span class="n">GRID_CONF</span>
<span class="w">      </span><span class="k">USE </span><span class="n">EMIS_DEFN</span>
<span class="w">      </span><span class="k">USE </span><span class="n">DEPV_DEFN</span>
<span class="w">      </span><span class="k">USE </span><span class="n">ASX_DATA_MOD</span>
<span class="w">      </span><span class="k">USE </span><span class="n">VDIFF_MAP</span>
<span class="w">      </span><span class="k">USE </span><span class="n">UTILIO_DEFN</span>
<span class="w">      </span><span class="k">USE </span><span class="n">BIDI_MOD</span>
<span class="w">      </span><span class="k">USE </span><span class="n">HGSIM</span>
<span class="w">      </span><span class="k">USE </span><span class="n">LSM_MOD</span><span class="p">,</span><span class="w"> </span><span class="k">Only</span><span class="p">:</span><span class="w"> </span><span class="n">n_lufrac</span>
<span class="w">      </span><span class="k">USE </span><span class="n">SEDIMENTATION</span>
<span class="w">      </span><span class="k">USE </span><span class="n">VDIFF_DIAG</span>
<span class="w">      </span><span class="k">USE </span><span class="n">PA_DEFN</span><span class="p">,</span><span class="w"> </span><span class="k">Only</span><span class="p">:</span><span class="w"> </span><span class="n">LIPR</span><span class="w"> </span><span class="c">! Process Anaylsis control and data variables</span>

<span class="w">      </span><span class="k">IMPLICIT NONE</span>

<span class="k">      INCLUDE </span><span class="n">SUBST_FILES_ID</span><span class="w">  </span><span class="c">! file name parameters</span>

<span class="w">      </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="mi">120</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; &#39;</span>

<span class="n">C</span><span class="w"> </span><span class="n">Arguments</span><span class="p">:</span>

<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">POINTER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CGRID</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">              </span><span class="c">!  concentrations</span>
<span class="w">      </span><span class="kt">INTEGER      </span><span class="n">JDATE</span><span class="w">        </span><span class="c">! current model date, coded YYYYDDD</span>
<span class="w">      </span><span class="kt">INTEGER      </span><span class="n">JTIME</span><span class="w">        </span><span class="c">! current model time, coded HHMMSS</span>
<span class="w">      </span><span class="kt">INTEGER      </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! time step vector (HHMMSS)</span>
<span class="w">                                </span><span class="c">! TSTEP(1) = local output step</span>
<span class="w">                                </span><span class="c">! TSTEP(2) = sciproc sync. step (chem)</span>
<span class="w">                                </span><span class="c">! TSTEP(3) = twoway model time step w.r.t. wrf time</span>
<span class="w">                                </span><span class="c">!            step and wrf/cmaq call frequency</span>

<span class="n">C</span><span class="w"> </span><span class="n">Parameters</span><span class="p">:</span>

<span class="n">C</span><span class="w"> </span><span class="k">External </span><span class="n">Functions</span><span class="p">:</span><span class="w"> </span><span class="k">None</span>

<span class="n">C</span><span class="w"> </span><span class="n">Local</span><span class="w"> </span><span class="n">Variables</span><span class="p">:</span>
<span class="w">      </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">PNAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;VDIFFPROC&#39;</span>
<span class="w">      </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">AERO_GRAV_SETL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CTM_GRAV_SETL&#39;</span>
<span class="w">      </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">VARDESC</span><span class="w">                </span><span class="c">! env variable description</span>
<span class="w">      </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">GRAV_SETL</span>
<span class="w">      </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">FIRSTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<span class="w">      </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">WRITE_FIRSTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<span class="w">      </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">WSTEP</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">               </span><span class="c">! local write counter</span>
<span class="w">      </span><span class="kt">INTEGER  </span><span class="n">STATUS</span><span class="w">                           </span><span class="c">! ENV... status</span>

<span class="w">      </span><span class="kt">REAL</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">FCJACMF</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">NLAYS</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c">! 1/ mid-full layer vert Jac factor</span>
<span class="w">      </span><span class="kt">REAL             </span><span class="n">LRDX3M</span><span class="w">                        </span><span class="c">! loop local RDX3M( L )</span>
<span class="w">      </span><span class="kt">REAL             </span><span class="n">FCMSF</span><span class="w">                         </span><span class="c">! loop local RMSFX4( C,R )</span>

<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="c">! cgrid aero in mixing ratio</span>
<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">DDEP</span><span class="w">     </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! ddep accumulator</span>
<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ICMP</span><span class="w">     </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! component flux accumlator</span>
<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">DDEPJ</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! ddep for mosaic</span>
<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! ddep for stomtal/cuticular pathway</span>

<span class="w">      </span><span class="kt">REAL</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">)</span><span class="w">                 </span><span class="c">! ddep write buffer</span>
<span class="w">      </span><span class="kt">REAL</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">WRDDJ</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">N_LUFRAC</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="c">! mosaic ddep write buffer</span>
<span class="w">      </span><span class="kt">REAL</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">WRDDJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">N_LUFRAC</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! mosaic stomatal flux write buffer</span>

<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">DDEP_PA</span><span class="w">  </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! ddep for process analysis</span>
<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">EMIS_PA</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! emis for process analysis</span>

<span class="w">      </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">N_SPC_CGRID</span><span class="w">              </span><span class="c">! no. of CGRID species</span>

<span class="w">      </span><span class="kt">REAL</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">EDDYV</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">NLAYS</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! from EDYINTB</span>
<span class="w">      </span><span class="kt">REAL</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">SEDDY</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">NLAYS</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! flipped EDDYV</span>
<span class="w">      </span><span class="kt">REAL        </span><span class="n">DTSEC</span><span class="w">                         </span><span class="c">! model time step in seconds</span>

<span class="w">      </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">VSED_AE</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="w"> </span><span class="n">Local</span><span class="w"> </span><span class="n">Variables</span>

<span class="w">      </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">SAVE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LOGDEV</span>

<span class="w">      </span><span class="kt">INTEGER     </span><span class="n">ASTAT</span>
<span class="w">      </span><span class="kt">INTEGER     </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">OFF</span><span class="w">      </span><span class="c">! loop induction variables</span>
<span class="w">      </span><span class="kt">INTEGER     </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">MSTEP</span><span class="w">           </span><span class="c">! internal simulation date&amp;time</span>

<span class="w">      </span><span class="k">INTERFACE</span>
<span class="k">         SUBROUTINE </span><span class="n">PA_UPDATE_EMIS</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">VDEMIS</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">PNAME</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w">           </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">VDEMIS</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">PA_UPDATE_EMIS</span>
<span class="w">         </span><span class="k">SUBROUTINE </span><span class="n">PA_UPDATE_DDEP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">PNAME</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w">           </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">DDEP</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">PA_UPDATE_DDEP</span>
<span class="w">         </span><span class="k">SUBROUTINE </span><span class="n">CONV_CGRID</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CGRID</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">POINTER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CGRID</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w">           </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">CONV_CGRID</span>
<span class="w">         </span><span class="k">SUBROUTINE </span><span class="n">REV_CGRID</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w">           </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w">        </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">POINTER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">CGRID</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">REV_CGRID</span>
<span class="w">         </span><span class="k">SUBROUTINE </span><span class="n">EDDYX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EDDYV</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w">           </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">OUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">EDDYV</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">EDDYX</span>
<span class="w">         </span><span class="k">SUBROUTINE </span><span class="n">VDIFFACMX</span><span class="p">(</span><span class="w"> </span><span class="n">dtsec</span><span class="p">,</span><span class="w"> </span><span class="n">seddy</span><span class="p">,</span><span class="w"> </span><span class="n">ddep</span><span class="p">,</span><span class="w"> </span><span class="n">icmp</span><span class="p">,</span><span class="w"> </span><span class="n">ddepj</span><span class="p">,</span><span class="w"> </span><span class="n">ddepj_fst</span><span class="p">,</span><span class="w"> </span><span class="n">cngrd</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="p">)</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">dtsec</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">seddy</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ddep</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">OPTIONAL</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ddepj</span><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">OPTIONAL</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ddepj_fst</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="w"> </span><span class="n">INOUT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cngrd</span><span class="p">(</span><span class="w"> </span><span class="p">:,:,:,:</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END SUBROUTINE </span><span class="n">VDIFFACMX</span>
<span class="w">      </span><span class="k">END INTERFACE</span>

<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>
<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FIRSTIME</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>

<span class="k">         </span><span class="n">FIRSTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<span class="w">         </span><span class="n">LOGDEV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INIT3</span><span class="p">()</span>

<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">DEPV_INIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure initializing deposition velocities module&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">maps</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">VDIFF_MAP_INIT</span><span class="p">(</span><span class="w"> </span><span class="n">N_SPC_DEPV</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure initializing index mapping module&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">Initialize</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">met</span><span class="w"> </span><span class="k">data</span>
<span class="k">         CALL </span><span class="n">INIT_MET</span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">MOSAIC</span><span class="p">,</span><span class="w"> </span><span class="n">ABFLUX</span><span class="p">,</span><span class="w"> </span><span class="n">HGBIDI</span><span class="w"> </span><span class="p">)</span>

<span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">HGBIDI</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! Initialize HGSIM module</span>
<span class="w">           </span><span class="k">CALL </span><span class="n">INIT_HGSIM</span><span class="p">(</span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">)</span>
<span class="w">        </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">gravitational</span><span class="w"> </span><span class="n">settling</span><span class="w"> </span><span class="p">(</span><span class="n">sedi</span><span class="p">)</span><span class="w"> </span><span class="n">flag</span><span class="p">.</span>
<span class="w">         </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w">         </span><span class="c">! default</span>
<span class="w">         </span><span class="n">VARDESC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Using J-,K-mode aerosols gravitational settling&#39;</span>
<span class="w">         </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ENVYN</span><span class="p">(</span><span class="w"> </span><span class="n">AERO_GRAV_SETL</span><span class="p">,</span><span class="w"> </span><span class="n">VARDESC</span><span class="p">,</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="p">,</span><span class="w"> </span><span class="n">STATUS</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">STATUS</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(5X, A)&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">VARDESC</span>

<span class="n">C</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">diagnostic</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">flag</span><span class="p">.</span>
<span class="w">         </span><span class="n">VDIFFDIAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w">         </span><span class="c">! default</span>
<span class="w">         </span><span class="n">VARDESC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Writing the VDIFF diagnostic files&#39;</span>
<span class="w">         </span><span class="n">VDIFFDIAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ENVYN</span><span class="p">(</span><span class="w"> </span><span class="n">VDIFF_DIAG_FILE</span><span class="p">,</span><span class="w"> </span><span class="n">VARDESC</span><span class="p">,</span><span class="w"> </span><span class="n">VDIFFDIAG</span><span class="p">,</span><span class="w"> </span><span class="n">STATUS</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">STATUS</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(5X, A)&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">VARDESC</span>

<span class="n">C</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="k">file </span><span class="n">characteristics</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">COORD</span><span class="p">.</span><span class="n">EXT</span><span class="w"> </span><span class="nb">and </span><span class="k">open </span><span class="n">the</span><span class="w"> </span><span class="n">dry</span><span class="w"> </span><span class="n">dep</span><span class="w"> </span><span class="k">file</span>
<span class="k">         IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IO_PE_INCLUSIVE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            CALL </span><span class="n">OPDDEP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">N_SPC_DDEP</span><span class="p">,</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">HGBIDI</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">OPASX_MEDIA</span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="k">Open </span><span class="n">vdiff</span><span class="w"> </span><span class="n">diagnostics</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="p">(</span><span class="n">ioapi</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">cgrd</span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">VDIFFDIAG</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">VDIFF_DIAG_INIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure initializing vdiff diagnostics module&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">         END IF</span>
<span class="n">C</span><span class="w"> </span><span class="k">Allocate </span><span class="nb">and </span><span class="n">initialize</span><span class="w"> </span><span class="n">dry</span><span class="w"> </span><span class="n">deposition</span><span class="w"> </span><span class="k">array</span>

<span class="k">         ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">DDEP</span><span class="p">(</span><span class="w"> </span><span class="n">N_SPC_DEPV</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating DDEP&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="k">         </span><span class="n">DDEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>

<span class="w">         </span><span class="k">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ICMP</span><span class="p">(</span><span class="w"> </span><span class="n">LCMP</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating ICMP&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="k">         </span><span class="n">ICMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>

<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">EMIS_INIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure initializing emissions module&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">analysis</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LIPR</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EMIS_PA</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">EMLAYS</span><span class="p">,</span><span class="n">N_SPC_EMIS</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;EMIS_PA memory allocation failed&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">DDEP_PA</span><span class="p">(</span><span class="w"> </span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="p">,</span><span class="n">N_SPC_DEPV</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DDEP_PA memory allocation failed&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">         END IF</span>
<span class="n">C</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">grav</span><span class="p">.</span><span class="w"> </span><span class="n">settling</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">VSED_AE</span><span class="p">(</span><span class="w"> </span><span class="n">N_AE_SPC</span><span class="p">,</span><span class="n">NLAYS</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating VSED_AE&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">         END IF</span>

<span class="k">         </span><span class="n">N_SPC_CGRID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SIZE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CGRID</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="p">)</span>

<span class="w">         </span><span class="k">ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">(</span><span class="w"> </span><span class="n">N_SPC_CGRID</span><span class="p">,</span><span class="n">NLAYS</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating CNGRD&#39;</span>
<span class="w">            </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="k">         </span><span class="n">CNGRD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>

<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">(</span><span class="w"> </span><span class="n">N_LUFRAC</span><span class="p">,</span><span class="n">N_SPC_DEPV</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating DDEPJ&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            </span><span class="n">DDEPJ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IO_PE_INCLUSIVE</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">         </span><span class="k">CALL </span><span class="n">OPDDEP_MOS</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">N_SPC_DDEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               ALLOCATE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">N_LUFRAC</span><span class="p">,</span><span class="n">N_SPC_DEPV</span><span class="p">,</span><span class="n">NCOLS</span><span class="p">,</span><span class="n">NROWS</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="nb">STAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ASTAT</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Failure allocating DDEPJ_FST&#39;</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>
<span class="k">               </span><span class="n">DDEPJ_FST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">               </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IO_PE_INCLUSIVE</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">            </span><span class="k">CALL </span><span class="n">OPDDEP_FST</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">N_SPC_DDEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span><span class="w">   </span><span class="c">! if Fst</span>
<span class="w">         </span><span class="k">END IF</span><span class="w">   </span><span class="c">! if Mosaic</span>

<span class="w">      </span><span class="k">END IF</span><span class="w">   </span><span class="c">!  if Firstime</span>

<span class="w">      </span><span class="n">MDATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDATE</span>
<span class="w">      </span><span class="n">MTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">      </span><span class="n">MSTEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TIME2SEC</span><span class="p">(</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="n">DTSEC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">(</span><span class="w"> </span><span class="n">MSTEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">CALL </span><span class="n">NEXTIME</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">SEC2TIME</span><span class="p">(</span><span class="w"> </span><span class="n">MSTEP</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="w"> </span><span class="n">Convert</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">molar</span><span class="w"> </span><span class="n">mixing</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="nb">and </span><span class="n">re</span><span class="o">-</span><span class="n">order</span><span class="w"> </span><span class="n">CGRID</span>
<span class="w">      </span><span class="k">CALL </span><span class="n">CONV_CGRID</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CGRID</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="n">C</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="n">met</span><span class="w"> </span><span class="k">data</span>
<span class="k">      CALL </span><span class="n">GET_MET</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">MSTEP</span><span class="p">,</span><span class="w"> </span><span class="n">MOSAIC</span><span class="p">,</span><span class="w"> </span><span class="n">ABFLUX</span><span class="p">,</span><span class="w"> </span><span class="n">HGBIDI</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="n">deposition</span><span class="w"> </span><span class="n">velocities</span>
<span class="w">      </span><span class="k">CALL </span><span class="n">GET_DEPV</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="w"> </span><span class="p">)</span>

<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="n">C</span><span class="w"> </span><span class="n">Get</span><span class="w"> </span><span class="n">gravitational</span><span class="w"> </span><span class="n">settling</span><span class="w"> </span><span class="n">velocity</span><span class="w"> </span><span class="n">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">vsed</span><span class="w"> </span><span class="n">aero</span><span class="w"> </span><span class="n">species</span><span class="p">:</span>
<span class="n">C</span><span class="w"> </span><span class="n">AERO_SEDV</span><span class="w"> </span><span class="n">assumes</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">every</span><span class="w"> </span><span class="n">aero</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="k">is </span><span class="n">dry</span><span class="w"> </span><span class="n">deposited</span><span class="w"> </span><span class="nb">and </span><span class="k">is </span><span class="n">diffused</span><span class="w"> </span><span class="p">(</span><span class="n">trns</span><span class="p">)</span>
<span class="n">C</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="n">J</span><span class="o">-</span><span class="p">,</span><span class="n">K</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">aerosol</span><span class="w"> </span><span class="n">concentrations</span>
<span class="w">         </span><span class="k">CALL </span><span class="n">SEDI</span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">DTSEC</span><span class="p">,</span><span class="w"> </span><span class="n">VSED_AE</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="p">,</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="k">read</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="n">interpolate</span><span class="w"> </span><span class="n">emissions</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">VDEMIS</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">EMIS_DEFN</span><span class="w"> </span><span class="k">module</span>
<span class="k">      CALL </span><span class="n">GET_EMIS</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">,</span><span class="w"> </span><span class="n">CONVPA</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="w"> </span><span class="p">)</span>

<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LIPR</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">         DO </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_SPC_EMIS</span><span class="o">+</span><span class="mi">1</span>
<span class="w">            </span><span class="k">DO </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">EMLAYS</span>
<span class="w">               </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                     </span><span class="n">EMIS_PA</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">S</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VDEMIS</span><span class="p">(</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END DO</span>
<span class="k">               END DO</span>
<span class="k">            END DO</span>
<span class="k">         END DO</span>
<span class="k">         CALL </span><span class="n">PA_UPDATE_EMIS</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;VDIF&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">EMIS_PA</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">END IF</span>

<span class="k">      CALL </span><span class="n">EDDYX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EDDYV</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="w"> </span><span class="n">EDDYV</span><span class="w"> </span><span class="n">returned</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Kz</span><span class="p">,</span><span class="w"> </span><span class="k">where </span><span class="n">Kz</span><span class="w"> </span><span class="k">is </span><span class="n">in</span><span class="w"> </span><span class="n">m</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sec</span>

<span class="w">      </span><span class="k">DO </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NLAYS</span>
<span class="w">         </span><span class="n">LRDX3M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Grid_Data</span><span class="p">%</span><span class="n">RDX3M</span><span class="p">(</span><span class="w"> </span><span class="n">L</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">            </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">               </span><span class="n">FCJACMF</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LRDX3M</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Met_Data</span><span class="p">%</span><span class="n">RJACM</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Met_Data</span><span class="p">%</span><span class="n">RJACF</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END DO</span>
<span class="k">         END DO</span>
<span class="k">      END DO</span>
<span class="k">      DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">         </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">            </span><span class="n">FCMSF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Grid_Data</span><span class="p">%</span><span class="n">RMSFX4</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">DO </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NLAYS</span>
<span class="w">               </span><span class="n">SEDDY</span><span class="p">(</span><span class="w"> </span><span class="n">L</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FCMSF</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">FCJACMF</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">EDDYV</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END DO</span>
<span class="k">         END DO</span>
<span class="k">      END DO</span>

<span class="k">      IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">WSTEP</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">         </span><span class="n">DDEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">                      </span><span class="c">! array assignment</span>
<span class="w">         </span><span class="n">ICMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">                      </span><span class="c">! array assignment</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">DDEPJ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">                  </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="k">      END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">concentration</span><span class="w"> </span><span class="nb">and </span><span class="n">dry</span><span class="w"> </span><span class="n">dep</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">vertical</span><span class="w"> </span><span class="n">diffusion</span><span class="w"> </span><span class="nb">and </span><span class="n">vsed</span>
<span class="n">C</span><span class="w"> </span><span class="n">Note</span><span class="p">:</span><span class="w"> </span><span class="n">cngrd</span><span class="w"> </span><span class="k">is </span><span class="n">the</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="n">keyword</span><span class="w"> </span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">INTERFACE</span><span class="p">);</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="k">is </span><span class="n">the</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">argument</span>
<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">         CALL </span><span class="n">VDIFFACMX</span><span class="p">(</span><span class="w"> </span><span class="n">DTSEC</span><span class="p">,</span><span class="w"> </span><span class="n">SEDDY</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP</span><span class="p">,</span><span class="w"> </span><span class="n">ICMP</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                   </span><span class="n">cngrd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">ELSE</span>
<span class="k">         IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            CALL </span><span class="n">VDIFFACMX</span><span class="p">(</span><span class="w"> </span><span class="n">DTSEC</span><span class="p">,</span><span class="w"> </span><span class="n">SEDDY</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP</span><span class="p">,</span><span class="w"> </span><span class="n">ICMP</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">ddepj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">,</span><span class="w"> </span><span class="n">cngrd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">ELSE</span>
<span class="k">            CALL </span><span class="n">VDIFFACMX</span><span class="p">(</span><span class="w"> </span><span class="n">DTSEC</span><span class="p">,</span><span class="w"> </span><span class="n">SEDDY</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP</span><span class="p">,</span><span class="w"> </span><span class="n">ICMP</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                      </span><span class="n">ddepj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">,</span><span class="w"> </span><span class="n">ddepj_fst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">,</span><span class="w"> </span><span class="n">cngrd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CNGRD</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="k">      END IF</span>

<span class="k">      IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">VDIFFDIAG</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">         </span><span class="n">NTICS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NTICS</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">NLPCR_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLPCR_SUM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">NLPCR_MEAN</span><span class="w">    </span><span class="c">! array assignment</span>
<span class="w">         </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">            </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">               </span><span class="n">NLPCR_MAX</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MAX</span><span class="p">(</span><span class="w"> </span><span class="n">NLPCR_MEAN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">NLPCR_MAX</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="n">NLPCR_MIN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MIN</span><span class="p">(</span><span class="w"> </span><span class="n">NLPCR_MEAN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">NLPCR_MIN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END DO</span>
<span class="k">         END DO</span>
<span class="k">         IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">DTCCR_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DTCCR_SUM</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DTCCR_MEAN</span><span class="w">    </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">               </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                  </span><span class="n">DTCCR_MAX</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MAX</span><span class="p">(</span><span class="w"> </span><span class="n">DTCCR_MEAN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">DTCCR_MAX</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="n">DTCCR_MIN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MIN</span><span class="p">(</span><span class="w"> </span><span class="n">DTCCR_MEAN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">DTCCR_MIN</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END DO</span>
<span class="k">            END DO</span>
<span class="k">         END IF</span>
<span class="k">      END IF</span>
<span class="n">C</span><span class="w"> </span><span class="n">Revert</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">molar</span><span class="w"> </span><span class="n">mixing</span><span class="w"> </span><span class="n">ratio</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="nb">and </span><span class="n">re</span><span class="o">-</span><span class="n">order</span><span class="w"> </span><span class="n">CGRID</span>
<span class="w">      </span><span class="k">CALL </span><span class="n">REV_CGRID</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CNGRD</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">CGRID</span><span class="w"> </span><span class="p">)</span>

<span class="n">C</span><span class="w"> </span><span class="k">If </span><span class="n">last</span><span class="w"> </span><span class="k">call </span><span class="n">this</span><span class="w"> </span><span class="n">hour</span><span class="p">:</span><span class="w">  </span><span class="k">write </span><span class="n">accumulated</span><span class="w"> </span><span class="n">depositions</span><span class="p">:</span>

<span class="w">      </span><span class="n">WSTEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WSTEP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TIME2SEC</span><span class="p">(</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">WSTEP</span><span class="w"> </span><span class="p">.</span><span class="n">GE</span><span class="p">.</span><span class="w"> </span><span class="n">TIME2SEC</span><span class="p">(</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">         </span><span class="n">MDATE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JDATE</span>
<span class="w">         </span><span class="n">MTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JTIME</span>
<span class="w">         </span><span class="k">CALL </span><span class="n">NEXTIME</span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="p">(</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="n">WSTEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="cp">#ifdef parallel_io</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">WRITE_FIRSTIME</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">WRITE_FIRSTIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>

<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">IO_PE_INCLUSIVE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">OPEN3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="p">,</span><span class="w"> </span><span class="n">FSREAD3</span><span class="p">,</span><span class="w"> </span><span class="n">PNAME</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not open &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">CTM_DRY_DEP_1</span><span class="p">)</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>
<span class="k">               IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">OPEN3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_MOS</span><span class="p">,</span><span class="w"> </span><span class="n">FSREAD3</span><span class="p">,</span><span class="w"> </span><span class="n">PNAME</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                     </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not open &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">CTM_DRY_DEP_MOS</span><span class="p">)</span>
<span class="w">                     </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END IF</span>
<span class="k">                  IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                     IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">OPEN3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_FST</span><span class="p">,</span><span class="w"> </span><span class="n">FSREAD3</span><span class="p">,</span><span class="w"> </span><span class="n">PNAME</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                        </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not open &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">CTM_DRY_DEP_FST</span><span class="p">)</span>
<span class="w">                        </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">                     </span><span class="k">END IF</span>
<span class="k">                  END IF</span>
<span class="k">               END IF</span>
<span class="k">            END IF</span><span class="w">   </span><span class="c">! .NOT. IO_PE_INCLUSIVE</span>
<span class="w">         </span><span class="k">END IF</span>
<span class="cp">#endif</span>

<span class="w">         </span><span class="k">DO </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_SPC_DDEP</span>
<span class="w">            </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DD2DV</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">               </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                  </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEP</span><span class="p">(</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END DO</span>
<span class="k">            END DO</span>

<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP_SPC</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">),</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                 </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">WRDD</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; file&#39;</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>

<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="w"> </span><span class="n">DDEP_SPC</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;NH3&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               DO </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">LCMP</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                     </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                        </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICMP</span><span class="p">(</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                     </span><span class="k">END DO</span>
<span class="k">                  END DO</span>
<span class="k">                  IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="p">,</span><span class="w"> </span><span class="n">CMPSPC</span><span class="p">(</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">),</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                 </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">WRDD</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                     </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; file&#39;</span>
<span class="w">                     </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END IF     </span>
<span class="k">               END DO       </span>
<span class="k">            ENDIF</span>

<span class="k">         END DO</span>

<span class="k">         WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;( /5X, 3( A, :, 1X ), I8, &quot;:&quot;, I6.6 )&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">         </span><span class="s1">&#39;Timestep written to&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">CTM_DRY_DEP_1</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">         </span><span class="s1">&#39;for date and time&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span>

<span class="n">C</span><span class="w"> </span><span class="k">Write </span><span class="n">vdiff</span><span class="w"> </span><span class="n">diagnostics</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">VDIFFDIAG</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">   </span><span class="c">! Write vsed diagnostics</span>

<span class="w">               </span><span class="k">DO </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_VSED</span>
<span class="w">                  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VSED_MAP</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">NLAYS</span>
<span class="w">                     </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                        </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                           </span><span class="n">VSED_BUF</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">V</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VSED_AE</span><span class="p">(</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                        </span><span class="k">END DO</span>
<span class="k">                     END DO</span>
<span class="k">                  END DO</span>
<span class="k">                  IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VSED_DIAG</span><span class="p">,</span><span class="w"> </span><span class="n">VSED_NAME</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">),</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                               </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">VSED_BUF</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">V</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                     </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="w"> </span><span class="n">VSED_NAME</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                    </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VSED_DIAG</span>
<span class="w">                     </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END IF</span>
<span class="k">               END DO</span>

<span class="k">               WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;( /5X, 3( A, :, 1X ), I8, &quot;:&quot;, I6.6 )&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">               </span><span class="s1">&#39;Timestep written to&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">CTM_VSED_DIAG</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">               </span><span class="s1">&#39;for date and time&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span>

<span class="w">            </span><span class="k">END IF</span><span class="w">   </span><span class="c">! GRAV_SETL</span>

<span class="n">C</span><span class="w"> </span><span class="k">Write </span><span class="n">other</span><span class="w"> </span><span class="n">diagnostics</span>
<span class="w">            </span><span class="n">NLPCR_MEAN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLPCR_SUM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">(</span><span class="w"> </span><span class="n">NTICS</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NLP_MEAN&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                         </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">NLPCR_MEAN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;NLP_MEAN to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NLP_MAX&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                         </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">NLPCR_MAX</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;NLP_MAX to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NLP_MIN&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                         </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">NLPCR_MIN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;NLP_MIN to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            </span><span class="n">NLPCR_MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">      </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="n">NLPCR_MIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9.9E30</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="n">NLPCR_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">      </span><span class="c">! array assignment</span>

<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GRAV_SETL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">   </span><span class="c">! Write vsed diagnostics</span>
<span class="w">               </span><span class="n">DTCCR_MEAN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DTCCR_SUM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">(</span><span class="w"> </span><span class="n">NTICS</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SEDI_DTC_MEAN&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                            </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">DTCCR_MEAN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;SEDI_DTC_MEAN to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>
<span class="k">               IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SEDI_DTC_MAX&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                            </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">DTCCR_MAX</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;SEDI_DTC_MAX to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>
<span class="k">               IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SEDI_DTC_MIN&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                            </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">DTCCR_MIN</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;SEDI_DTC_MIN to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>
<span class="k">               </span><span class="n">DTCCR_MAX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">      </span><span class="c">! array assignment</span>
<span class="w">               </span><span class="n">DTCCR_MIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">9.9E30</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">               </span><span class="n">DTCCR_SUM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">      </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">END IF</span>

<span class="k">            </span><span class="n">CNVCT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">               </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                  </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Met_Data</span><span class="p">%</span><span class="n">CONVCT</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">CNVCT</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">               </span><span class="k">END DO</span>
<span class="k">            END DO</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;CONVCT&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                         </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">CNVCT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;convct to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>
<span class="k">            IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;LPBL&#39;</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                         </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="w"> </span><span class="n">Met_Data</span><span class="p">%</span><span class="n">LPBL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">               </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="s1">&#39;lpbl to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span>
<span class="w">               </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="k">END IF</span>

<span class="k">            WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;( /5X, 3( A, :, 1X ), I8, &quot;:&quot;, I6.6, I6 )&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">            </span><span class="s1">&#39;Timestep written to&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">CTM_VDIFF_DIAG</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">            </span><span class="s1">&#39;for date and time (and ntics)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">NTICS</span>
<span class="w">            </span><span class="n">NTICS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">         </span><span class="k">END IF</span>

<span class="k">         IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>

<span class="k">            DO </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_SPC_DDEP</span>
<span class="w">               </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DD2DV</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="n">WRDD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="c">! reuse array since it has already been written for hour</span>
<span class="w">               </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                     </span><span class="k">DO </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_LUFRAC</span>
<span class="w">                        </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Grid_Data</span><span class="p">%</span><span class="n">LUFRAC</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">J</span><span class="w"> </span><span class="p">)</span>
<span class="w">                        </span><span class="n">WRDDJ</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">J</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                     </span><span class="k">END DO</span>
<span class="k">                     </span><span class="n">WRDDJ</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">N_LUFRAC</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c">! last array element is total across all land use categories</span>
<span class="w">                  </span><span class="k">END DO</span>
<span class="k">               END DO</span>

<span class="k">               IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_MOS</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP_SPC</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">),</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                     </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">WRDDJ</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                  </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_DRY_DEP_MOS</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; file&#39;</span>
<span class="w">                  </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">               </span><span class="k">END IF</span>

<span class="k">            END DO</span>

<span class="k">            WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;( /5X, 3( A, :, 1X ), I8, &quot;:&quot;, I6.6 )&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">             </span><span class="s1">&#39;Timestep written to&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">CTM_DRY_DEP_MOS</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">             </span><span class="s1">&#39;for date and time&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span>

<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>

<span class="k">               DO </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_SPC_DDEP</span>
<span class="w">                  </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DD2DV</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="n">WRDD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="c">! reuse array since it has already been written for hour</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                     </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                        </span><span class="k">DO </span><span class="n">J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_LUFRAC</span>
<span class="w">                           </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Grid_Data</span><span class="p">%</span><span class="n">LUFRAC</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">J</span><span class="w"> </span><span class="p">)</span>
<span class="w">                           </span><span class="n">WRDDJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">J</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                           </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                              WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;FST too big !!!&#39;</span>
<span class="w">                              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;J,S,C,R = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">R</span>
<span class="w">                              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;DDEPJ,DDEPJ_FST: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">DDEPJ</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;DDEP Species: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP_SPC</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">)</span>
<span class="w">                              </span><span class="k">WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Time and date: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span>
<span class="w">                           </span><span class="k">END IF</span>
<span class="k">                        END DO</span>
<span class="k">                        </span><span class="n">WRDDJ_FST</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">N_LUFRAC</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRDD</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c">! last array element is total across all land use categories</span>
<span class="w">                    </span><span class="k">END DO</span>
<span class="k">                  END DO</span>

<span class="k">                  IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">WRITE3</span><span class="p">(</span><span class="w"> </span><span class="n">CTM_DRY_DEP_FST</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP_SPC</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="p">),</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">                       </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">WRDDJ_FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">                     </span><span class="n">XMSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Could not write &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">CTM_DRY_DEP_FST</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; file&#39;</span>
<span class="w">                     </span><span class="k">CALL </span><span class="n">M3EXIT</span><span class="p">(</span><span class="w"> </span><span class="n">PNAME</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">XMSG</span><span class="p">,</span><span class="w"> </span><span class="n">XSTAT1</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END IF</span>

<span class="k">               END DO</span>

<span class="k">               WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">LOGDEV</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;( /5X, 3( A, :, 1X ), I8, &quot;:&quot;, I6.6 )&#39;</span><span class="w"> </span><span class="p">)</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">               </span><span class="s1">&#39;Timestep written to&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">CTM_DRY_DEP_FST</span><span class="p">,</span>
<span class="w">     </span><span class="p">&amp;</span><span class="w">               </span><span class="s1">&#39;for date and time&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span>

<span class="w">            </span><span class="k">END IF</span><span class="w">   </span><span class="c">! FST</span>

<span class="w">         </span><span class="k">END IF</span><span class="w">   </span><span class="c">! MOSAIC</span>

<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">HGBIDI</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN    </span>
<span class="k">            CALL </span><span class="n">WRASX_MEDIA</span><span class="p">(</span><span class="w"> </span><span class="n">MDATE</span><span class="p">,</span><span class="w"> </span><span class="n">MTIME</span><span class="p">,</span><span class="w"> </span><span class="n">ABFLUX</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="k">         IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LIPR</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            DO </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">N_SPC_DEPV</span>
<span class="w">               </span><span class="k">DO </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NROWS</span>
<span class="w">                  </span><span class="k">DO </span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MY_NCOLS</span>
<span class="w">                     </span><span class="n">DDEP_PA</span><span class="p">(</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DDEP</span><span class="p">(</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">R</span><span class="w"> </span><span class="p">)</span>
<span class="w">                  </span><span class="k">END DO</span>
<span class="k">               END DO</span>
<span class="k">            END DO</span>
<span class="k">            CALL </span><span class="n">PA_UPDATE_DDEP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;VDIF&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">DDEP_PA</span><span class="p">,</span><span class="w"> </span><span class="n">JDATE</span><span class="p">,</span><span class="w"> </span><span class="n">JTIME</span><span class="p">,</span><span class="w"> </span><span class="n">TSTEP</span><span class="w"> </span><span class="p">)</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="n">C</span><span class="w"> </span><span class="n">re</span><span class="o">-</span><span class="n">set</span><span class="w"> </span><span class="n">dry</span><span class="w"> </span><span class="n">deposition</span><span class="w"> </span><span class="k">array </span><span class="n">to</span><span class="w"> </span><span class="n">zero</span>

<span class="w">         </span><span class="n">DDEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">         </span><span class="n">ICMP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MOSAIC</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="k">            </span><span class="n">DDEPJ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">            </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">FST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">DDEPJ_FST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w">   </span><span class="c">! array assignment</span>
<span class="w">         </span><span class="k">END IF</span>

<span class="k">      END IF</span>

<span class="k">      RETURN</span>
<span class="k">      END</span>
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ol class="arabic simple">
<li><p>Header comments - Highly recommended for internal documentation.</p></li>
<li><p>USE <module name> includes the Fortran source file specified.</p></li>
<li><p>IMPLICIT NONE must be used in Fortran 90, i.e., implicit declarations are not supported. This dramatically reduces errors due to typos and undefined variables.</p></li>
<li><p>Chemical mechanism array dimensioning and looping global variables.</p></li>
<li><p>C preprocessor flags that determine which emissions control dimensioning and looping variables are compiled.</p></li>
<li><p>Other global array dimensioning and looping global variables, including those for the I/O API. The logical variable LIPR is defined in the SUBST_PACTL_ID INCLUDE file for use at lines labeled (18).</p></li>
<li><p>Local variable declaration. Note syntax differences from Fortran-77.</p></li>
<li><p>Declarations for the argument list (standardized).</p></li>
<li><p>Declarations and PARAMETER statements for local Fortran parameters, illustrating in-line documentation of variables and units. Note syntax differences from Fortran-77.</p></li>
<li><p>Declarations for external functions not previously declared.</p></li>
<li><p>Declarations for arrays to hold external file data.</p></li>
<li><p>Declarations and definitions for local and saved variables, and dynamic memory allocations.</p></li>
<li><p>Interface is a convenient way to declare calling arguments to a subroutine as input, output, or both in the calling program through the INTENT variable specification (as IN, OUT, or IN OUT). No other declaration of the calling arguments is necessary in the calling program. If IN only, the values of arguments can be passed explicitly in the subroutine call. If OUT, the argument must be passed as a variable.</p></li>
<li><p>Code section for subroutine initialization and for any local data that need not be set at every entry into the subroutine. Such data would require a SAVE statement in the declarations. For example, FIRSTIME is initialized to .TRUE. in the local variables section.</p></li>
<li><p>Illustration of memory allocation for a variable declared as allocatable. In this example, NLAYS is accessed from the COORD.EXT file.</p></li>
<li><p>Illustrates using an I/O API function to set file interpolation time.</p></li>
<li><p>Meteorological and other data are read and interpolated through a series of subroutine calls. These subroutines in turn use I/O API utilities to perform the time interpolation of the desired met variables, deposited and emitted species.</p></li>
<li><p>Call to process analysis routine to obtain data for the optional integrated process rates function.</p></li>
<li><p>Illustrates call to another science process within the module.</p></li>
<li><p>Main computational loop over the horizontal grid.</p></li>
<li><p>Time-step loop over subsynchronization time step intervals.</p></li>
<li><p>Illustrates writing to an I/O API file within a module.</p></li>
<li><p>Subroutine end</p></li>
</ol>
</section>
</section>
<section id="compiling-cmaq-with-new-source-code">
<h2>Compiling CMAQ with New Source Code<a class="headerlink" href="#compiling-cmaq-with-new-source-code" title="Link to this heading">#</a></h2>
<p>The following steps are recommended for compiling CMAQ when a new module has been developed. The procedure creates a Makefile, which can then be modified to add the new module in the appropriate class, but the same steps can be used to obtain a configuration file that can be similarly modified to add the new module.</p>
<ul class="simple">
<li><p>On the computational platform of choice, install CMAQ using Git.</p></li>
<li><p>In the $CMAQ_HOME/CCTM/scripts/ subdirectory, modify a file called bldit.cctm by uncommenting the line “set MakeOpt” (remove the leading ‘#’ character).</p></li>
<li><p>Execute the bldit.cctm script. This creates a Makefile as well as a configuration file in the subdirectory $CMAQ_HOME/CCTM/scripts/BLD_CCTM_v52b_{compiler}, where the model code has been copied.</p></li>
<li><p>The Makefile can be modified to compile and link the new module by specifying <full path name>.o for the object file that needs to be linked in. It is essential that a source file with the corresponding name (with extension “.F”) reside in the same directory as the specified path name for the object file.</p></li>
<li><p>Issue the “make” command to compile the source code into an executable.</p></li>
</ul>
</section>
<section id="guidelines-to-writing-shell-scripts-for-cmaq">
<h2>Guidelines to Writing Shell Scripts for CMAQ<a class="headerlink" href="#guidelines-to-writing-shell-scripts-for-cmaq" title="Link to this heading">#</a></h2>
<p>To run a model executable, various UNIX environment variables must be set in the shell that invokes the execute command. Generally, these variables involve the modeling scenario start date and time, the run duration, the output time step interval, various internal code flags that differ among the models, and all the input and output logical (symbolic) file names. There are various ways that external file names can be referenced in the source code, and UNIX platforms can link them by using environment variables. There are I/O API utility functions that allow users to easily access these variables in the code in a generic and portable manner. An additional feature that is provided through the I/O API is the ability to declare a file “volatile” by appending a -v flag in the shell’s declaration for the environment variable. By doing this, the I/O API will cause the netCDF file to update (sync) its disk copy after every write and thereby update the netCDF header. Otherwise, netCDF (I/O API) file headers are not updated until the files are closed. This feature is useful, for example, for allowing a user to analyze an open netCDF file using visualization tools while the model is executing. It is also useful in case of a system crash. A CCTM model can be restarted at the scenario time step after the last successful write using the aborted output file as the input initial data.</p>
<p>The following is a sample run script that can be downloaded from the CMAS web site. The build and run scripts are part of the downloaded tar file from this site.</p>
<div class="highlight-Tcsh notranslate"><div class="highlight"><pre><span></span><span class="c">#!/bin/csh -f</span>

<span class="c"># ====================== CCTMv5.1 Run Script ======================</span>
<span class="c"># Usage: run.cctm &gt;&amp;! cctm_D51a.log &amp;                                </span>
<span class="c">#</span>
<span class="c"># To report problems or request help with this script/program:        </span>
<span class="c">#             http://www.cmascenter.org</span>
<span class="c"># ===================================================================</span>

<span class="c"># ==================================================================</span>
<span class="c">#&gt; Runtime Environment Options</span>
<span class="c"># ==================================================================</span>

<span class="c">#&gt; Choose compiler and set up CMAQ environment with correct</span>
<span class="c">#&gt; libraries using config.cmaq. Options: intel | gcc | pgi</span>
 <span class="nb">setenv </span>compiler intel
 <span class="nb">setenv </span>compilerVrsn 13.1

<span class="c">#&gt; Source the config.cmaq file to set the build environment</span>
 <span class="nb">cd</span> ../..
 <span class="nb">source</span> ./config_cmaq.csh
 <span class="nb">cd </span>CCTM/scripts

<span class="c">#&gt; Set General Parameters for Configuring the Simulation</span>
 <span class="nb">set </span><span class="nv">VRSN</span>      <span class="o">=</span> v52               <span class="c">#&gt; Code Version</span>
 <span class="nb">set </span><span class="nv">PROC</span>      <span class="o">=</span> mpi               <span class="c">#&gt; serial or mpi</span>
 <span class="nb">set </span><span class="nv">MECH</span>      <span class="o">=</span> cb6r3_ae6_aq      <span class="c">#&gt; Mechanism ID</span>
 <span class="nb">set </span><span class="nv">EMIS</span>      <span class="o">=</span> 2013ef            <span class="c">#&gt; Emission Inventory Details</span>
 <span class="nb">set </span><span class="nv">APPL</span>      <span class="o">=</span> SE52BENCH         <span class="c">#&gt; Application Name (e.g. Gridname)</span>

<span class="c">#&gt; Define RUNID as any combination of parameters above or others. By default,</span>
<span class="c">#&gt; this information will be collected into this one string, $RUNID, for easy</span>
<span class="c">#&gt; referencing in output binaries and log files as well as in other scripts.</span>
 <span class="nb">setenv </span>RUNID  <span class="k">${</span><span class="nv">VRSN</span><span class="k">}</span>_<span class="k">${</span><span class="nv">compiler</span><span class="k">}</span>_<span class="k">${</span><span class="nv">APPL</span><span class="k">}</span>

<span class="c">#&gt; Set the build directory (this is where the CMAQ executable</span>
<span class="c">#&gt; is located by default).</span>
 <span class="nb">set </span><span class="nv">BLD</span>      <span class="o">=</span> <span class="k">${</span><span class="nv">CMAQ_HOME</span><span class="k">}</span>/CCTM/scripts/BLD_CCTM_<span class="k">${</span><span class="nv">VRSN</span><span class="k">}</span>_<span class="k">${</span><span class="nv">compiler</span><span class="k">}</span>
 <span class="nb">set </span><span class="nv">EXEC</span>     <span class="o">=</span> CCTM_<span class="k">${</span><span class="nv">VRSN</span><span class="k">}</span>.exe
 cat <span class="nv">$BLD</span>/CCTM_<span class="k">${</span><span class="nv">VRSN</span><span class="k">}</span>.cfg<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&quot;    &quot;</span><span class="p">;</span> <span class="nb">set echo</span>

<span class="c">#&gt; Set Working, Input, and Output Directories</span>
 <span class="nb">setenv </span>WORKDIR <span class="k">${</span><span class="nv">CMAQ_HOME</span><span class="k">}</span>/CCTM/scripts       <span class="c">#&gt; Working Directory. Where the runscript is.</span>
 <span class="nb">setenv </span>OUTDIR  <span class="k">${</span><span class="nv">CMAQ_DATA</span><span class="k">}</span>/output_CCTM_<span class="k">${</span><span class="nv">RUNID</span><span class="k">}</span> <span class="c">#&gt; Output Directory</span>
 <span class="nb">setenv </span>INPDIR  <span class="k">${</span><span class="nv">CMAQ_DATA</span><span class="k">}</span>/SE52BENCH/single_day/cctm_input  <span class="c">#&gt; Input Directory</span>
 <span class="nb">setenv </span>LOGDIR  <span class="k">${</span><span class="nv">OUTDIR</span><span class="k">}</span>          <span class="c">#&gt; Log Directory Location</span>
 <span class="nb">setenv </span>NMLpath <span class="k">${</span><span class="nv">BLD</span><span class="k">}</span>             <span class="c">#&gt; Location of Namelists. Common places are:</span>
                                   <span class="c">#&gt;   ${WORKDIR} | ${CCTM_SRC}/MECHS/${MECH} | ${BLD}</span>

<span class="c"># =====================================================================</span>
<span class="c">#&gt; CCTM Configuration Options</span>
<span class="c"># =====================================================================</span>

<span class="c">#&gt; Set Start and End Days for looping</span>
 <span class="nb">setenv </span>NEW_START TRUE            <span class="c">#&gt; Set to FALSE for model restart</span>
 <span class="nb">set </span><span class="nv">START_DATE</span> <span class="o">=</span> <span class="s2">&quot;2011-07-01&quot;</span>     <span class="c">#&gt; beginning date (July 1, 2011)</span>
 <span class="nb">set </span><span class="nv">END_DATE</span>   <span class="o">=</span> <span class="s2">&quot;2011-07-01&quot;</span>     <span class="c">#&gt; ending date    (July 14, 2011)</span>

<span class="c">#&gt; Set Timestepping Parameters</span>
<span class="nb">set </span><span class="nv">STTIME</span>     <span class="o">=</span> 000000            <span class="c">#&gt; beginning GMT time (HHMMSS)</span>
<span class="nb">set </span><span class="nv">NSTEPS</span>     <span class="o">=</span> 240000            <span class="c">#&gt; time duration (HHMMSS) for this run</span>
<span class="nb">set </span><span class="nv">TSTEP</span>      <span class="o">=</span> 010000            <span class="c">#&gt; output time step interval (HHMMSS)</span>

<span class="c">#&gt; Horizontal domain decomposition</span>
<span class="k">if</span> <span class="o">(</span> <span class="nv">$PROC</span> <span class="o">==</span> serial <span class="o">)</span> <span class="k">then</span>
<span class="k">   </span><span class="nb">setenv </span>NPCOL_NPROW <span class="s2">&quot;1 1&quot;</span><span class="p">;</span> <span class="nb">set </span><span class="nv">NPROCS</span>   <span class="o">=</span> 1 <span class="c"># single processor setting</span>
<span class="k">else</span>
   @ <span class="nv">NPCOL</span>  <span class="o">=</span>  4<span class="p">;</span> @ <span class="nv">NPROW</span> <span class="o">=</span>  2
   @ <span class="nv">NPROCS</span> <span class="o">=</span> <span class="nv">$NPCOL</span> * <span class="nv">$NPROW</span>
   <span class="nb">setenv </span>NPCOL_NPROW <span class="s2">&quot;$NPCOL $NPROW&quot;</span><span class="p">;</span>
<span class="k">endif</span>

<span class="c">#&gt; Vertical extent</span>
<span class="nb">set </span><span class="nv">NZ</span>         <span class="o">=</span> 35

<span class="c">#setenv LOGFILE $CMAQ_HOME/$RUNID.log  #&gt; log file name; uncomment to write standard output to a log, otherwise write to screen</span>

<span class="nb">setenv </span>GRID_NAME SE52BENCH         <span class="c">#&gt; check GRIDDESC file for GRID_NAME options</span>
<span class="nb">setenv </span>GRIDDESC <span class="nv">$INPDIR</span>/GRIDDESC   <span class="c">#&gt; grid description file</span>

<span class="c">#&gt; Output Species and Layer Options</span>
<span class="c">#&gt;   CONC file species; comment or set to &quot;ALL&quot; to write all species to CONC</span>
     <span class="c">#setenv CONC_SPCS &quot;O3 NO ANO3I ANO3J NO2 FORM ISOP ANH4J ASO4I ASO4J&quot;</span>
     <span class="c">#setenv CONC_BLEV_ELEV &quot; 1 4&quot; #&gt; CONC file layer range; comment to write all layers to CONC</span>

<span class="c">#&gt;   ACONC file species; comment or set to &quot;ALL&quot; to write all species to ACONC</span>
     <span class="c">#setenv AVG_CONC_SPCS &quot;O3 NO CO NO2 ASO4I ASO4J NH3&quot;</span>
     <span class="nb">setenv </span>AVG_CONC_SPCS <span class="s2">&quot;ALL&quot;</span>
     <span class="nb">setenv </span>ACONC_BLEV_ELEV <span class="s2">&quot; 1 1&quot;</span> <span class="c">#&gt; ACONC file layer range; comment to write all layers to ACONC</span>
     <span class="c">#setenv ACONC_END_TIME Y      #&gt; override default beginning ACON timestamp [ default: N ]</span>

<span class="nb">setenv </span>EXECUTION_ID <span class="nv">$EXEC</span>    <span class="c">#&gt; define the model execution id</span>

<span class="c">#&gt; Sychronization Time Step and Tolerance Options</span>
<span class="nb">setenv </span>CTM_MAXSYNC 300       <span class="c">#&gt; max sync time step (sec) [ default: 720 ]</span>
<span class="nb">setenv </span>CTM_MINSYNC  60       <span class="c">#&gt; min sync time step (sec) [ default: 60 ]</span>
<span class="nb">setenv </span>SIGMA_SYNC_TOP 0.7    <span class="c">#&gt; top sigma level thru which sync step determined [ default: 0.7 ]</span>
<span class="c">#setenv ADV_HDIV_LIM 0.95     #&gt; maximum horiz. div. limit for adv step adjust [ default: 0.9 ]</span>
<span class="nb">setenv </span>CTM_ADV_CFL 0.95      <span class="c">#&gt; max CFL [ default: 0.75]</span>
<span class="c">#setenv RB_ATOL 1.0E-09       #&gt; global ROS3 solver abs tol [ default: 1.0E-07 ]</span>

<span class="c">#&gt; Science Options</span>
<span class="nb">setenv </span>CTM_WB_DUST Y         <span class="c">#&gt; use inline windblown dust emissions [ default: Y ]</span>
<span class="nb">setenv </span>CTM_ERODE_AGLAND Y    <span class="c">#&gt; use agricultural activity for windblown dust</span>
                             <span class="c">#&gt;    [ default: N ]; ignore if CTM_WB_DUST = N</span>
<span class="nb">setenv </span>CTM_WBDUST_BELD BELD3 <span class="c">#&gt; landuse database for identifying dust source regions</span>
                             <span class="c">#&gt;    [ default: BELD3 ]; ignore if CTM_WB_DUST = N</span>
<span class="nb">setenv </span>CTM_LTNG_NO Y         <span class="c">#&gt; turn on lightning NOx [ default: N ]</span>
<span class="nb">setenv </span>CTM_WVEL Y            <span class="c">#&gt; save derived vertical velocity component to conc</span>
                             <span class="c">#&gt;    file [ default: N ]</span>
<span class="nb">setenv </span>KZMIN Y               <span class="c">#&gt; use Min Kz option in edyintb [ default: Y ],</span>
                             <span class="c">#&gt;    otherwise revert to Kz0UT</span>
<span class="nb">setenv </span>CTM_ILDEPV Y          <span class="c">#&gt; calculate in-line deposition velocities [ default: Y ]</span>
<span class="nb">setenv </span>CTM_MOSAIC N          <span class="c">#&gt; landuse specific deposition velocities [ default: N ]</span>
<span class="nb">setenv </span>CTM_ABFLUX Y          <span class="c">#&gt; ammonia bi-directional flux for in-line deposition</span>
                             <span class="c">#&gt;    velocities [ default: N ]; ignore if CTM_ILDEPV = N</span>
<span class="nb">setenv </span>CTM_HGBIDI N          <span class="c">#&gt; mercury bi-directional flux for in-line deposition</span>
                             <span class="c">#&gt;    velocities [ default: N ]; ignore if CTM_ILDEPV = N</span>
<span class="nb">setenv </span>CTM_SFC_HONO Y        <span class="c">#&gt; surface HONO interaction [ default: Y ]; ignore if CTM_ILDEPV = N</span>
<span class="nb">setenv </span>CTM_GRAV_SETL Y       <span class="c">#&gt; vdiff aerosol gravitational sedimentation [ default: Y ]</span>
<span class="nb">setenv </span>CTM_BIOGEMIS Y        <span class="c">#&gt; calculate in-line biogenic emissions [ default: N ]</span>
<span class="nb">setenv </span>CTM_PT3DEMIS Y        <span class="c">#&gt; calculate in-line plume rise for elevated point emissions</span>
                             <span class="c">#&gt;    [ default: N ]</span>
<span class="nb">setenv </span>CTM_ZERO_PCSOA N      <span class="c">#&gt; turn off the emissions of the VOC precursor to pcSOA.</span>
                             <span class="c">#&gt;    The CMAQ dev team recommends leaving pcSOA mass in the</span>
                             <span class="c">#&gt;    model for production runs. [ default: N ]</span>

<span class="c">#&gt; Process Analysis Options</span>
<span class="nb">setenv </span>CTM_PROCAN N          <span class="c">#&gt; use process analysis [ default: N]</span>
<span class="c">#&gt; process analysis global column, row and layer ranges</span>
<span class="c">#&gt; user must check GRIDDESC for validity!</span>
<span class="nb">setenv </span>PA_BCOL_ECOL <span class="s2">&quot;10 320&quot;</span>
<span class="nb">setenv </span>PA_BROW_EROW <span class="s2">&quot;10 195&quot;</span>
<span class="nb">setenv </span>PA_BLEV_ELEV <span class="s2">&quot;1  4&quot;</span>

<span class="c">#&gt; I/O Controls</span>
<span class="nb">setenv </span>IOAPI_LOG_WRITE F     <span class="c">#&gt; turn on excess WRITE3 logging [ options: T | F ]</span>
<span class="nb">setenv </span>FL_ERR_STOP N         <span class="c">#&gt; stop on inconsistent input files</span>
<span class="nb">setenv </span>PROMPTFLAG F          <span class="c">#&gt; turn on I/O-API PROMPT*FILE interactive mode [ options: T | F ]</span>
<span class="nb">setenv </span>IOAPI_OFFSET_64 NO    <span class="c">#&gt; support large timestep records (&gt;2GB/timestep record) [ options: YES | NO ]</span>
<span class="nb">setenv </span>CTM_EMISCHK N         <span class="c">#&gt; Abort CMAQ if missing surrogates from emissions Input files</span>

<span class="c">#&gt; Aerosol Diagnostic Controls</span>
<span class="nb">setenv </span>CTM_AVISDIAG Y        <span class="c">#&gt; Aerovis diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>AVG_FILE_ENDTIME N    <span class="c">#&gt; What is this [ default: N ]</span>

<span class="c">#&gt; Diagnostic Output Flags</span>
<span class="nb">setenv </span>CTM_CKSUM Y           <span class="c">#&gt; cksum report [ default: Y ]</span>
<span class="nb">setenv </span>CLD_DIAG Y            <span class="c">#&gt; cloud diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>CTM_AERDIAG Y         <span class="c">#&gt; aerosol diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>CTM_PHOTDIAG Y        <span class="c">#&gt; photolysis diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>CTM_SSEMDIAG Y        <span class="c">#&gt; sea-salt emissions diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>CTM_DUSTEM_DIAG Y     <span class="c">#&gt; windblown dust emissions diagnostic file [ default: N ]; ignore if CTM_WB_DUST = N</span>
<span class="nb">setenv </span>CTM_DEPV_FILE Y       <span class="c">#&gt; deposition velocities diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>VDIFF_DIAG_FILE Y     <span class="c">#&gt; vdiff &amp; possibly aero grav. sedimentation diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>LTNGDIAG Y            <span class="c">#&gt; lightning diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>CTM_AOD Y             <span class="c">#&gt; AOD diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>B3GTS_DIAG Y          <span class="c">#&gt; beis mass emissions diagnostic file [ default: N ]</span>
<span class="nb">setenv </span>PT3DDIAG N            <span class="c">#&gt; optional 3d point source emissions diagnostic file [ default: N]; ignore if CTM_PT3DEMIS = N</span>
<span class="nb">setenv </span>PT3DFRAC N            <span class="c">#&gt; optional layer fractions diagnostic (play) file(s) [ default: N]; ignore if CTM_PT3DEMIS = N</span>
<span class="nb">setenv </span>REP_LAYER_MIN -1      <span class="c">#&gt; Minimum layer for reporting plume rise info [ default: -1 ]</span>

<span class="nb">set </span><span class="nv">DISP</span> <span class="o">=</span> delete            <span class="c">#&gt; [ delete | keep ] existing output files</span>


<span class="c"># =====================================================================</span>
<span class="c">#&gt; Input Directories and Filenames</span>
<span class="c"># =====================================================================</span>

<span class="nb">set </span><span class="nv">ICpath</span>    <span class="o">=</span> <span class="nv">$INPDIR</span>/icbc              <span class="c">#&gt; initial conditions input directory</span>
<span class="nb">set </span><span class="nv">BCpath</span>    <span class="o">=</span> <span class="nv">$INPDIR</span>/icbc              <span class="c">#&gt; boundary conditions input directory</span>
<span class="nb">set </span><span class="nv">EMISpath</span>  <span class="o">=</span> <span class="nv">$INPDIR</span>/emis/gridded_area <span class="c">#&gt; surface emissions input directory</span>
<span class="nb">set </span><span class="nv">IN_PTpath</span> <span class="o">=</span> <span class="nv">$INPDIR</span>/emis/inln_point   <span class="c">#&gt; elevated emissions input directory (in-line point only)</span>
<span class="nb">set </span><span class="nv">IN_LTpath</span> <span class="o">=</span> <span class="nv">$INPDIR</span>/lightning         <span class="c">#&gt; lightning NOx input directory</span>
<span class="nb">set </span><span class="nv">METpath</span>   <span class="o">=</span> <span class="nv">$INPDIR</span>/met/mcip          <span class="c">#&gt; meteorology input directory</span>
<span class="c">#set JVALpath  = $INPDIR/jproc            #&gt; offline photolysis rate table directory</span>
<span class="nb">set </span><span class="nv">OMIpath</span>   <span class="o">=</span> <span class="nv">$BLD</span>                      <span class="c">#&gt; ozone columne data for the photolysis model</span>
<span class="nb">set </span><span class="nv">LUpath</span>    <span class="o">=</span> <span class="nv">$INPDIR</span>/land              <span class="c">#&gt; BELD landuse data for windblown dust model</span>
<span class="nb">set </span><span class="nv">SZpath</span>    <span class="o">=</span> <span class="nv">$INPDIR</span>/land              <span class="c">#&gt; surf zone file for in-line seasalt emissions</span>

<span class="nb">set </span><span class="nv">ICBC_CASE</span> <span class="o">=</span> 2013ef_v6_13g_s07         <span class="c">#&gt; Version label for the ICBCs</span>
<span class="nb">set </span><span class="nv">EMIS_CASE</span> <span class="o">=</span> 2013ef_v6_13g_s07_hg      <span class="c">#&gt; Version Label for the Emissions</span>

<span class="c"># =====================================================================</span>
<span class="c">#&gt; Begin Loop Through Simulation Days</span>
<span class="c"># =====================================================================</span>

<span class="nb">set </span><span class="nv">TODAYG</span> <span class="o">=</span> <span class="k">${</span><span class="nv">START_DATE</span><span class="k">}</span>
<span class="nb">set </span><span class="nv">TODAYJ</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${START_DATE}&quot;</span> +%Y%j<span class="sb">`</span> <span class="c">#&gt; Convert YYYY-MM-DD to YYYYJJJ</span>
<span class="nb">set </span><span class="nv">STOP_DAY</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${END_DATE}&quot;</span> +%Y%j<span class="sb">`</span> <span class="c">#&gt; Convert YYYY-MM-DD to YYYYJJJ</span>

<span class="k">while</span> <span class="o">(</span><span class="nv">$TODAYJ</span> &lt;<span class="o">=</span> <span class="nv">$STOP_DAY</span> <span class="o">)</span>  <span class="c">#&gt;Compare dates in terms of YYYYJJJ</span>

  <span class="c">#&gt; Retrieve Calendar day Information</span>
  <span class="nb">set </span><span class="nv">YYYYMMDD</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${TODAYG}&quot;</span> +%Y%m%d<span class="sb">`</span> <span class="c">#&gt; Convert YYYY-MM-DD to YYYYMMDD</span>
  <span class="nb">set </span><span class="nv">YYMMDD</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${TODAYG}&quot;</span> +%y%m%d<span class="sb">`</span>   <span class="c">#&gt; Convert YYYY-MM-DD to YYMMDD</span>
  <span class="nb">set </span><span class="nv">YYYYJJJ</span> <span class="o">=</span> <span class="nv">$TODAYJ</span>

  <span class="c">#&gt; Calculate Yesterday&#39;s Date</span>
  <span class="nb">set </span><span class="nv">YESTERDAY</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${TODAYG}-1days&quot;</span> +%Y%m%d<span class="sb">`</span> <span class="c">#&gt; Convert YYYY-MM-DD to YYYYJJJ</span>

<span class="c"># =====================================================================</span>
<span class="c">#&gt; Input Files (Some are Day-Dependent)</span>
<span class="c"># =====================================================================</span>

  <span class="c">#&gt; Initial conditions</span>
  <span class="k">if</span> <span class="o">(</span><span class="nv">$NEW_START</span> <span class="o">==</span> true || <span class="nv">$NEW_START</span> <span class="o">==</span> TRUE <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">setenv </span>ICFILE ICON_20110630_bench.nc
     rm -rf <span class="nv">$LOGDIR</span>/CTM_LOG*<span class="k">${</span><span class="nv">RUNID</span><span class="k">}</span>*  <span class="c"># Remove all Log Files Since this is a new start</span>
     mkdir -p <span class="nv">$OUTDIR</span>
  <span class="k">else</span>
<span class="k">     </span><span class="nb">set </span><span class="nv">ICpath</span> <span class="o">=</span> <span class="nv">$OUTDIR</span>
     <span class="nb">setenv </span>ICFILE CCTM_CGRID_<span class="k">${</span><span class="nv">RUNID</span><span class="k">}</span>_<span class="k">${</span><span class="nv">YESTERDAY</span><span class="k">}</span>.nc
  <span class="k">endif</span>

  <span class="c">#&gt; Boundary conditions</span>
  <span class="nb">set </span><span class="nv">BCFILE</span> <span class="o">=</span> BCON_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_bench.nc

  <span class="c">#&gt; Off-line photolysis rates</span>
  <span class="c">#set JVALfile  = JTABLE_${YYYYJJJ}</span>

  <span class="c">#&gt; Ozone column data</span>
  <span class="nb">set </span><span class="nv">OMIfile</span>   <span class="o">=</span> OMI_1979_to_2015.dat

  <span class="c">#&gt; Optics file</span>
  <span class="nb">set </span><span class="nv">OPTfile</span> <span class="o">=</span> PHOT_OPTICS.dat

  <span class="c">#&gt; MCIP meteorology files</span>
  <span class="nb">setenv </span>GRID_BDY_2D <span class="nv">$METpath</span>/GRIDBDY2D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>GRID_CRO_2D <span class="nv">$METpath</span>/GRIDCRO2D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>GRID_CRO_3D <span class="nv">$METpath</span>/GRIDCRO3D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>GRID_DOT_2D <span class="nv">$METpath</span>/GRIDDOT2D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>MET_CRO_2D <span class="nv">$METpath</span>/METCRO2D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>MET_CRO_3D <span class="nv">$METpath</span>/METCRO3D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>MET_DOT_3D <span class="nv">$METpath</span>/METDOT3D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc
  <span class="nb">setenv </span>MET_BDY_3D <span class="nv">$METpath</span>/METBDY3D_<span class="k">${</span><span class="nv">YYMMDD</span><span class="k">}</span>.nc

  <span class="nb">setenv </span>LAYER_FILE <span class="nv">$MET_CRO_3D</span>  <span class="c"># Deprecated: MET_CRO_3D is now read directly in CCTM</span>


  <span class="c">#&gt; Emissions files</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_PT3DEMIS</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span> <span class="o">)</span> <span class="k">then</span>
     <span class="c">#&gt; Offline 3d emissions file name</span>
     <span class="nb">set </span><span class="nv">EMISfile</span>  <span class="o">=</span> emis_mole_all_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_cb6_bench.nc
  <span class="k">else</span>
     <span class="c">#&gt; In-line emissions configuration</span>
     <span class="nb">set </span><span class="nv">STKCASEG</span> <span class="o">=</span> 12US1_2011ek_cb6cmaq_v6_11g           <span class="c"># Stack Group Version Label</span>
     <span class="nb">set </span><span class="nv">STKCASEE</span> <span class="o">=</span> 12US1_cmaq_cb6e51_2011ek_cb6cmaq_v6_11g   <span class="c"># Stack Emission Version Label</span>
     <span class="nb">set </span><span class="nv">EMISfile</span>  <span class="o">=</span> emis_mole_all_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_cb6_bench.nc <span class="c">#&gt; Surface emissions</span>
     <span class="nb">setenv </span>NPTGRPS 5          <span class="c">#&gt; Number of elevated source groups</span>

     <span class="nb">setenv </span>STK_GRPS_01 <span class="nv">$IN_PTpath</span>/stack_groups/stack_groups_ptnonipm_<span class="k">${</span><span class="nv">STKCASEG</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_GRPS_02 <span class="nv">$IN_PTpath</span>/stack_groups/stack_groups_ptegu_<span class="k">${</span><span class="nv">STKCASEG</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_GRPS_03 <span class="nv">$IN_PTpath</span>/stack_groups/stack_groups_othpt_<span class="k">${</span><span class="nv">STKCASEG</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_GRPS_04 <span class="nv">$IN_PTpath</span>/stack_groups/stack_groups_ptfire_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEG</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_GRPS_05 <span class="nv">$IN_PTpath</span>/stack_groups/stack_groups_pt_oilgas_<span class="k">${</span><span class="nv">STKCASEG</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>LAYP_STTIME <span class="nv">$STTIME</span>
     <span class="nb">setenv </span>LAYP_NSTEPS <span class="nv">$NSTEPS</span>

     <span class="nb">setenv </span>STK_EMIS_01 <span class="nv">$IN_PTpath</span>/ptnonipm/inln_mole_ptnonipm_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEE</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_EMIS_02 <span class="nv">$IN_PTpath</span>/ptegu/inln_mole_ptegu_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEE</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_EMIS_03 <span class="nv">$IN_PTpath</span>/othpt/inln_mole_othpt_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEE</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_EMIS_04 <span class="nv">$IN_PTpath</span>/ptfire/inln_mole_ptfire_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEE</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>STK_EMIS_05 <span class="nv">$IN_PTpath</span>/pt_oilgas/inln_mole_pt_oilgas_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_<span class="k">${</span><span class="nv">STKCASEE</span><span class="k">}</span>.nc
     <span class="nb">setenv </span>LAYP_STDATE <span class="nv">$YYYYJJJ</span>
  <span class="k">endif</span>

  <span class="c">#&gt; Lightning NOx configuration</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_LTNG_NO</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">setenv </span>LTNGNO <span class="s2">&quot;InLine&quot;</span>    <span class="c">#&gt; set LTNGNO to &quot;Inline&quot; to activate in-line calculation</span>

  <span class="c">#&gt; In-line lightning NOx options</span>
     <span class="nb">setenv </span>USE_NLDN  Y        <span class="c">#&gt; use hourly NLDN strike file [ default: Y ]</span>
     <span class="nb">setenv </span>LTNGPARAM Y        <span class="c">#&gt; use lightning parameter file [ default: Y ]</span>
     <span class="k">if</span> <span class="o">(</span> <span class="nv">$USE_NLDN</span> <span class="o">==</span> Y <span class="o">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nb">setenv </span>NLDN_STRIKES <span class="nv">$INPDIR</span>/lightning/NLDN.12US1.<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_bench.nc
     <span class="k">else</span>
<span class="k">        </span><span class="nb">setenv </span>LOG_START 2.0   <span class="c">#&gt; RC value to transit linear to log linear</span>
     <span class="k">endif</span>
<span class="k">     </span><span class="nb">setenv </span>LTNGPARMS_FILE <span class="nv">$INPDIR</span>/lightning/LTNG_AllParms_12US1_bench.nc <span class="c">#&gt; lightning parameter file; ignore if LTNGPARAM = N</span>
  <span class="k">endif</span>


  <span class="c">#&gt; In-line biogenic emissions configuration</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_BIOGEMIS</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">set </span><span class="nv">IN_BEISpath</span> <span class="o">=</span> <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land
     <span class="nb">set </span><span class="nv">GSPROpath</span>   <span class="o">=</span> <span class="k">${</span><span class="nv">IN_BEISpath</span><span class="k">}</span>
     <span class="nb">setenv </span>GSPRO      <span class="nv">$GSPROpath</span>/gspro_biogenics_1mar2017.txt
     <span class="nb">setenv </span>B3GRD      <span class="nv">$IN_BEISpath</span>/b3grd_bench.nc
     <span class="nb">setenv </span>BIOG_SPRO  B10C6 <span class="c">#&gt; speciation profile to use for biogenics</span>
     <span class="nb">setenv </span>BIOSW_YN   N     <span class="c">#&gt; use frost date switch [ default: Y ]</span>
     <span class="nb">setenv </span>BIOSEASON  <span class="nv">$IN_BEISpath</span>/bioseason.12US1.2006.09apr2012_bench.nc <span class="c">#&gt; ignore season switch file if BIOSW_YN = N</span>
     <span class="nb">setenv </span>SUMMER_YN  N     <span class="c">#&gt; Use summer normalized emissions? [ default: Y ]</span>
     <span class="nb">setenv </span>PX_VERSION Y     <span class="c">#&gt; MCIP is PX version? [ default: N ]</span>
     <span class="nb">setenv </span>SOILINP    <span class="nv">$OUTDIR</span>/CCTM_SOILOUT_<span class="k">${</span><span class="nv">RUNID</span><span class="k">}</span>_<span class="k">${</span><span class="nv">YESTERDAY</span><span class="k">}</span>.nc
                             <span class="c">#&gt; Biogenic NO soil input file; ignore if NEW_START = TRUE</span>
  <span class="k">endif</span>

  <span class="c">#&gt; Windblown dust emissions configuration</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_WB_DUST</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="o">)</span> <span class="k">then</span>
     <span class="c"># Input variables for BELD3 Landuse option</span>
     <span class="nb">setenv </span>DUST_LU_1 <span class="nv">$LUpath</span>/beld3_12US1_459X299_output_a_bench.nc
     <span class="nb">setenv </span>DUST_LU_2 <span class="nv">$LUpath</span>/beld4_12US1_459X299_output_tot_bench.nc
     <span class="nb">setenv </span>MODIS_FPAR <span class="nv">$LUpath</span>/modis_bench.nc

     <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_ERODE_AGLAND</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">        </span><span class="nb">setenv </span>CROPMAP01 <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/BeginPlanting_12km_bench.nc
        <span class="nb">setenv </span>CROPMAP04 <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/EndPlanting_12km_bench.nc
        <span class="nb">setenv </span>CROPMAP08 <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/EndHarvesting_12km_bench.nc
     <span class="k">endif</span>
<span class="k">  endif</span>

  <span class="c">#&gt; In-line sea salt emisisions configuration</span>
  <span class="nb">setenv </span>OCEAN_1 <span class="nv">$SZpath</span>/12US1_surf_bench.nc <span class="c">#&gt; horizontal grid-dependent surf zone file</span>

  <span class="c">#&gt; Bidiretional ammonia configuration</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$CTM_ABFLUX</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">setenv </span>E2C_Soilfile  <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/2011_US1_soil_bench.nc
     <span class="nb">setenv </span>E2C_Fertfile  <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/2011_US1_time<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>_bench.nc
     <span class="nb">setenv </span>B4LU_file     <span class="k">${</span><span class="nv">INPDIR</span><span class="k">}</span>/land/beld4_12kmCONUS_2006nlcd_bench.nc
     <span class="nb">setenv </span>E2C_SOIL <span class="k">${</span><span class="nv">E2C_Soilfile</span><span class="k">}</span>
     <span class="nb">setenv </span>E2C_FERT <span class="k">${</span><span class="nv">E2C_Fertfile</span><span class="k">}</span>
     <span class="nb">setenv </span>BELD4_LU <span class="k">${</span><span class="nv">B4LU_file</span><span class="k">}</span>
  <span class="k">endif</span>

<span class="c"># =====================================================================</span>
<span class="c">#&gt; Output Files</span>
<span class="c"># =====================================================================</span>
  <span class="c">#&gt; set output file name extensions</span>
  <span class="nb">setenv </span>CTM_APPL <span class="k">${</span><span class="nv">RUNID</span><span class="k">}</span>_<span class="k">${</span><span class="nv">YYYYMMDD</span><span class="k">}</span>
  <span class="c">#&gt; set output file names</span>
  <span class="nb">setenv </span>S_CGRID         <span class="s2">&quot;$OUTDIR/CCTM_CGRID_${CTM_APPL}.nc&quot;</span>         <span class="c">#&gt; 3D Inst. Concenctrations</span>
  <span class="nb">setenv </span>CTM_CONC_1      <span class="s2">&quot;$OUTDIR/CCTM_CONC_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; On-Hour Concentrations</span>
  <span class="nb">setenv </span>A_CONC_1        <span class="s2">&quot;$OUTDIR/CCTM_ACONC_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Hourly Avg. Concentrations</span>
  <span class="nb">setenv </span>MEDIA_CONC      <span class="s2">&quot;$OUTDIR/CCTM_MEDIA_CONC_${CTM_APPL}.nc -v&quot;</span> <span class="c">#&gt; NH3 Conc. in Media</span>
  <span class="nb">setenv </span>CTM_DRY_DEP_1   <span class="s2">&quot;$OUTDIR/CCTM_DRYDEP_${CTM_APPL}.nc -v&quot;</span>     <span class="c">#&gt; Hourly Dry Deposition</span>
  <span class="nb">setenv </span>CTM_DEPV_DIAG   <span class="s2">&quot;$OUTDIR/CCTM_DEPV_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; Dry Deposition Velocities</span>
  <span class="nb">setenv </span>CTM_PT3D_DIAG   <span class="s2">&quot;$OUTDIR/CCTM_PT3D_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt;</span>
  <span class="nb">setenv </span>B3GTS_S         <span class="s2">&quot;$OUTDIR/CCTM_B3GTS_S_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Biogenic Emissions</span>
  <span class="nb">setenv </span>SOILOUT         <span class="s2">&quot;$OUTDIR/CCTM_SOILOUT_${CTM_APPL}.nc&quot;</span>       <span class="c">#&gt; Soil Emissions</span>
  <span class="nb">setenv </span>CTM_WET_DEP_1   <span class="s2">&quot;$OUTDIR/CCTM_WETDEP1_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Wet Dep From All Clouds</span>
  <span class="nb">setenv </span>CTM_WET_DEP_2   <span class="s2">&quot;$OUTDIR/CCTM_WETDEP2_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Wet Dep From SubGrid Clouds</span>
  <span class="nb">setenv </span>CTM_VIS_1       <span class="s2">&quot;$OUTDIR/CCTM_PMVIS_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; On-Hour Visibility</span>
  <span class="nb">setenv </span>CTM_AVIS_1      <span class="s2">&quot;$OUTDIR/CCTM_APMVIS_${CTM_APPL}.nc -v&quot;</span>     <span class="c">#&gt; Hourly-Averaged Visibility</span>
  <span class="nb">setenv </span>CTM_ELMO_1      <span class="s2">&quot;$OUTDIR/CCTM_ELMO_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; On-Hour Particle Diagnostics</span>
  <span class="nb">setenv </span>CTM_AELMO_1     <span class="s2">&quot;$OUTDIR/CCTM_AELMO_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Hourly Avg. Particle Diagnostic</span>
  <span class="nb">setenv </span>CTM_RJ_1        <span class="s2">&quot;$OUTDIR/CCTM_PHOTDIAG1_${CTM_APPL}.nc -v&quot;</span>  <span class="c">#&gt; Photolysis Rxn Diagnostics</span>
  <span class="nb">setenv </span>CTM_RJ_2        <span class="s2">&quot;$OUTDIR/CCTM_PHOTDIAG2_${CTM_APPL}.nc -v&quot;</span>  <span class="c">#&gt; Photolysis Rates Output</span>
  <span class="nb">setenv </span>CTM_SSEMIS_1    <span class="s2">&quot;$OUTDIR/CCTM_SSEMIS.${CTM_APPL}.nc -v&quot;</span>     <span class="c">#&gt; Sea Spray Emissions</span>
  <span class="nb">setenv </span>CTM_DUST_EMIS_1 <span class="s2">&quot;$OUTDIR/CCTM_DUSTEMIS.${CTM_APPL}.nc -v&quot;</span>   <span class="c">#&gt; Dust Emissions</span>
  <span class="nb">setenv </span>CTM_IPR_1       <span class="s2">&quot;$OUTDIR/CCTM_PA_1_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; Process Analysis</span>
  <span class="nb">setenv </span>CTM_IPR_2       <span class="s2">&quot;$OUTDIR/CCTM_PA_2_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; Process Analysis</span>
  <span class="nb">setenv </span>CTM_IPR_3       <span class="s2">&quot;$OUTDIR/CCTM_PA_3_${CTM_APPL}.nc -v&quot;</span>       <span class="c">#&gt; Process Analysis</span>
  <span class="nb">setenv </span>CTM_IRR_1       <span class="s2">&quot;$OUTDIR/CCTM_IRR_1_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Chem Process Analysis</span>
  <span class="nb">setenv </span>CTM_IRR_2       <span class="s2">&quot;$OUTDIR/CCTM_IRR_2_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Chem Process Analysis</span>
  <span class="nb">setenv </span>CTM_IRR_3       <span class="s2">&quot;$OUTDIR/CCTM_IRR_3_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Chem Process Analysis</span>
  <span class="nb">setenv </span>CTM_DRY_DEP_MOS <span class="s2">&quot;$OUTDIR/CCTM_DDMOS_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Dry Dep</span>
  <span class="nb">setenv </span>CTM_DRY_DEP_FST <span class="s2">&quot;$OUTDIR/CCTM_DDFST_${CTM_APPL}.nc -v&quot;</span>      <span class="c">#&gt; Dry Dep</span>
  <span class="nb">setenv </span>CTM_DEPV_MOS    <span class="s2">&quot;$OUTDIR/CCTM_DEPVFST_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Dry Dep Velocity</span>
  <span class="nb">setenv </span>CTM_DEPV_FST    <span class="s2">&quot;$OUTDIR/CCTM_DEPVMOS_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Dry Dep Velocity</span>
  <span class="nb">setenv </span>CTM_VDIFF_DIAG  <span class="s2">&quot;$OUTDIR/CCTM_VDIFF_DIAG_${CTM_APPL}.nc -v&quot;</span> <span class="c">#&gt; Vertical Dispersion Diagnostic</span>
  <span class="nb">setenv </span>CTM_VSED_DIAG   <span class="s2">&quot;$OUTDIR/CCTM_VSED_DIAG_${CTM_APPL}.nc -v&quot;</span>  <span class="c">#&gt; Particle Grav. Settling Velocity</span>
  <span class="nb">setenv </span>CTM_AOD_1       <span class="s2">&quot;$OUTDIR/CCTM_AOD_DIAG_${CTM_APPL}.nc -v&quot;</span>   <span class="c">#&gt; Aerosol Optical Depth Diagnostic</span>
  <span class="nb">setenv </span>CTM_LTNGDIAG_1  <span class="s2">&quot;$OUTDIR/CCTM_LTNGHRLY_${CTM_APPL}.nc -v&quot;</span>   <span class="c">#&gt; Hourly Avg Lightning NO</span>
  <span class="nb">setenv </span>CTM_LTNGDIAG_2  <span class="s2">&quot;$OUTDIR/CCTM_LTNGCOL_${CTM_APPL}.nc -v&quot;</span>    <span class="c">#&gt; Column Total Lightning NO</span>

  <span class="c">#&gt; set floor file (neg concs)</span>
  <span class="nb">setenv </span>FLOOR_FILE <span class="k">${</span><span class="nv">OUTDIR</span><span class="k">}</span>/FLOOR_<span class="k">${</span><span class="nv">CTM_APPL</span><span class="k">}</span>.txt

  <span class="c">#&gt; create output directory</span>
  <span class="k">if</span> <span class="o">(</span> ! -d <span class="s2">&quot;$OUTDIR&quot;</span> <span class="o">)</span> mkdir -p <span class="nv">$OUTDIR</span>

  <span class="c">#&gt; look for existing log files and output files</span>
  <span class="nb">set </span><span class="nv">log_test</span> <span class="o">=</span> <span class="sb">`</span>ls CTM_LOG_???.<span class="k">${</span><span class="nv">CTM_APPL</span><span class="k">}</span><span class="sb">`</span>
  <span class="nb">set </span><span class="nv">OUT_FILES</span> <span class="o">=</span> <span class="s2">&quot;${FLOOR_FILE} ${S_CGRID} ${CTM_CONC_1} ${A_CONC_1} ${MEDIA_CONC}         \</span>
<span class="s2">             ${CTM_DRY_DEP_1} $CTM_DEPV_DIAG $CTM_PT3D_DIAG $B3GTS_S $SOILOUT $CTM_WET_DEP_1\</span>
<span class="s2">             $CTM_WET_DEP_2 $CTM_VIS_1 $CTM_AVIS_1 $CTM_ELMO_1 $CTM_AELMO_1             \</span>
<span class="s2">             $CTM_RJ_1 $CTM_RJ_2 $CTM_SSEMIS_1 $CTM_DUST_EMIS_1 $CTM_IPR_1 $CTM_IPR_2       \</span>
<span class="s2">             $CTM_IPR_3 $CTM_IRR_1 $CTM_IRR_2 $CTM_IRR_3 $CTM_DRY_DEP_MOS                   \</span>
<span class="s2">             $CTM_DRY_DEP_FST $CTM_DEPV_MOS $CTM_DEPV_FST $CTM_VDIFF_DIAG $CTM_VSED_DIAG    \</span>
<span class="s2">             $CTM_AOD_1 $CTM_LTNGDIAG_1 $CTM_LTNGDIAG_2&quot;</span>
  <span class="nb">set </span><span class="nv">OUT_FILES</span> <span class="o">=</span> <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$OUT_FILES</span> | sed <span class="s2">&quot;s; -v;;g&quot;</span> <span class="sb">`</span>
  <span class="nb">echo</span> <span class="nv">$OUT_FILES</span>
  <span class="nb">set </span><span class="nv">out_test</span> <span class="o">=</span> <span class="sb">`</span>ls <span class="nv">$OUT_FILES</span><span class="sb">`</span>

  <span class="c">#&gt; delete previous output if requested</span>
  <span class="k">if</span> <span class="o">(</span> <span class="nv">$DISP</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span> <span class="o">)</span> <span class="k">then</span>
     <span class="c">#&gt; remove previous log files</span>
     <span class="nb">echo</span> <span class="s2">&quot; ancillary log files being deleted&quot;</span>
     <span class="k">foreach </span>file <span class="o">(</span> <span class="nv">$log_test</span> <span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot; deleting $file&quot;</span>
        /bin/rm -f <span class="nv">$file</span>
     <span class="k">end</span>

     <span class="c">#&gt; remove previous output files</span>
     <span class="nb">echo</span> <span class="s2">&quot; output files being deleted&quot;</span>
     <span class="k">foreach </span>file <span class="o">(</span> <span class="nv">$out_test</span> <span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot; deleting $file&quot;</span>
        /bin/rm -f <span class="nv">$file</span>
     <span class="k">end</span>

<span class="k">  else</span>
     <span class="c">#&gt; remove previous log files</span>
     <span class="k">if</span> <span class="o">(</span> <span class="s2">&quot;$log_test&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;*** Logs exist - run ABORTED ***&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*** To overide, set $DISP == delete in run_cctm.csh ***&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*** and these files will be automatically deleted. ***&quot;</span>
       <span class="nb">exit </span>1
     <span class="k">endif</span>

     <span class="c">#&gt; remove previous output files</span>
     <span class="k">if</span> <span class="o">(</span> <span class="s2">&quot;$out_test&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;*** Output Files Exist - run will be ABORTED ***&quot;</span>
       <span class="k">foreach </span>file <span class="o">(</span> <span class="nv">$out_test</span> <span class="o">)</span>
          <span class="nb">echo</span> <span class="s2">&quot; cannot delete $file&quot;</span>
          /bin/rm -f <span class="nv">$file</span>
       <span class="k">end</span>
<span class="k">       </span><span class="nb">echo</span> <span class="s2">&quot;*** To overide, set $DISP == delete in run_cctm.csh ***&quot;</span>
       <span class="nb">echo</span> <span class="s2">&quot;*** and these files will be automatically deleted. ***&quot;</span>
       <span class="nb">exit </span>1
     <span class="k">endif</span>
<span class="k">  endif</span>

  <span class="c">#&gt; for the run control ...</span>
  <span class="nb">setenv </span>CTM_STDATE      <span class="nv">$YYYYJJJ</span>
  <span class="nb">setenv </span>CTM_STTIME      <span class="nv">$STTIME</span>
  <span class="nb">setenv </span>CTM_RUNLEN      <span class="nv">$NSTEPS</span>
  <span class="nb">setenv </span>CTM_TSTEP       <span class="nv">$TSTEP</span>
  <span class="nb">setenv </span>EMIS_1 <span class="nv">$EMISpath</span>/<span class="nv">$EMISfile</span>
  <span class="nb">setenv </span>INIT_GASC_1 <span class="nv">$ICpath</span>/<span class="nv">$ICFILE</span>
  <span class="nb">setenv </span>INIT_AERO_1 <span class="nv">$INIT_GASC_1</span>
  <span class="nb">setenv </span>INIT_NONR_1 <span class="nv">$INIT_GASC_1</span>
  <span class="nb">setenv </span>INIT_TRAC_1 <span class="nv">$INIT_GASC_1</span>
  <span class="nb">setenv </span>BNDY_GASC_1 <span class="nv">$BCpath</span>/<span class="nv">$BCFILE</span>
  <span class="nb">setenv </span>BNDY_AERO_1 <span class="nv">$BNDY_GASC_1</span>
  <span class="nb">setenv </span>BNDY_NONR_1 <span class="nv">$BNDY_GASC_1</span>
  <span class="nb">setenv </span>BNDY_TRAC_1 <span class="nv">$BNDY_GASC_1</span>
  <span class="nb">setenv </span>OMI <span class="nv">$OMIpath</span>/<span class="nv">$OMIfile</span>
  <span class="nb">setenv </span>OPTICS_DATA <span class="nv">$OMIpath</span>/<span class="nv">$OPTfile</span>
  <span class="c">#setenv XJ_DATA $JVALpath/$JVALfile</span>
  <span class="nb">set </span><span class="nv">TR_DVpath</span> <span class="o">=</span> <span class="nv">$METpath</span>
  <span class="nb">set </span><span class="nv">TR_DVfile</span> <span class="o">=</span> <span class="nv">$MET_CRO_2D</span>

  <span class="c">#&gt; species defn &amp; photolysis</span>
  <span class="nb">setenv </span>gc_matrix_nml <span class="k">${</span><span class="nv">NMLpath</span><span class="k">}</span>/GC_<span class="nv">$MECH</span>.nml
  <span class="nb">setenv </span>ae_matrix_nml <span class="k">${</span><span class="nv">NMLpath</span><span class="k">}</span>/AE_<span class="nv">$MECH</span>.nml
  <span class="nb">setenv </span>nr_matrix_nml <span class="k">${</span><span class="nv">NMLpath</span><span class="k">}</span>/NR_<span class="nv">$MECH</span>.nml
  <span class="nb">setenv </span>tr_matrix_nml <span class="k">${</span><span class="nv">NMLpath</span><span class="k">}</span>/Species_Table_TR_0.nml

  <span class="c">#&gt; check for photolysis input data</span>
  <span class="nb">setenv </span>CSQY_DATA <span class="k">${</span><span class="nv">NMLpath</span><span class="k">}</span>/CSQY_DATA_<span class="nv">$MECH</span>

  <span class="k">if</span> <span class="o">(</span>! <span class="o">(</span>-e <span class="nv">$CSQY_DATA</span> <span class="o">)</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">echo</span> <span class="s2">&quot; $CSQY_DATA  not found &quot;</span>
     <span class="nb">exit </span>1
  <span class="k">endif</span>
<span class="k">  if</span> <span class="o">(</span>! <span class="o">(</span>-e <span class="nv">$OPTICS_DATA</span> <span class="o">)</span> <span class="o">)</span> <span class="k">then</span>
<span class="k">     </span><span class="nb">echo</span> <span class="s2">&quot; $OPTICS_DATA  not found &quot;</span>
     <span class="nb">exit </span>1
  <span class="k">endif</span>

<span class="c"># ===================================================================</span>
<span class="c">#&gt; Execution Portion</span>
<span class="c"># ===================================================================</span>

  <span class="c">#&gt; Print attributes of the executable</span>
  ls -l <span class="nv">$BLD</span>/<span class="nv">$EXEC</span><span class="p">;</span> size <span class="nv">$BLD</span>/<span class="nv">$EXEC</span>
  <span class="nb">unlimit</span>
<span class="nb">  limit</span>

<span class="nb">  </span>date

  <span class="c">#&gt; Executable call for single PE, uncomment to invoke</span>
  <span class="c"># /usr/bin/time  $BLD/$EXEC</span>

  <span class="c">#&gt; Executable call for multi PE, configure for your system</span>
  <span class="c"># set MPI = /usr/local/intel/impi/3.2.2.006/bin64</span>
  <span class="c"># set MPIRUN = $MPI/mpirun</span>
  <span class="nb">time </span>mpirun -r ssh -np <span class="nv">$NPROCS</span> <span class="nv">$BLD</span>/<span class="nv">$EXEC</span>

  date

<span class="c"># ===================================================================</span>
<span class="c">#&gt; Finalize Run for This Day and Loop to Next Day</span>
<span class="c"># ===================================================================</span>

  <span class="c">#&gt; Save Log Files and Move on to Next Simulation Day</span>
  mv CTM_LOG_???.<span class="k">${</span><span class="nv">CTM_APPL</span><span class="k">}</span> <span class="nv">$LOGDIR</span>

  <span class="c">#&gt; The next simulation day will, by definition, be a restart</span>
  <span class="nb">setenv </span>NEW_START false

  <span class="c">#&gt; Increment both Gregorian and Julian Days</span>
  <span class="nb">set </span><span class="nv">TODAYG</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${TODAYG}+1days&quot;</span> +%Y-%m-%d<span class="sb">`</span> <span class="c">#&gt; Add a day for tomorrow</span>
  <span class="nb">set </span><span class="nv">TODAYJ</span> <span class="o">=</span> <span class="sb">`</span>date -ud <span class="s2">&quot;${TODAYG}&quot;</span> +%Y%j<span class="sb">`</span> <span class="c">#&gt; Convert YYYY-MM-DD to YYYYJJJ</span>

<span class="k">end</span>  <span class="c">#Loop to the next Simulation Day</span>

<span class="nb">exit</span>
</pre></div>
</div>
</section>
<section id="testing-and-distribution-of-development-source-code">
<h2>Testing and Distribution of Development Source Code<a class="headerlink" href="#testing-and-distribution-of-development-source-code" title="Link to this heading">#</a></h2>
<p>The CMAS Center collects, tests, and distributes various operational and development versions of CMAQ through the web site <a class="reference external" href="http://www.cmaq-model.org/" rel="noreferrer" target="_blank"><a class="reference external" href="http://www.cmaq-model.org" rel="noreferrer" target="_blank">http://www.cmaq-model.org <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a> <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a>. An archive of official releases (both current and past) and development versions of CMAQ is available to the user community. The CMAQ-MADRID and CMAQ-AMSTERDAM developed by AER, Inc. under funding from the Electric Power Research Institute can be downloaded from this archive. As a benefit to the CMAQ community, CMAS periodically updates its documentation on testing such development code versions to include additional feedback as it becomes available, based on users’ experiences with these versions. Questions or comments about development versions of CMAQ such as CMAQ-MADRID should be directed to the developers at AER. Questions or comments about downloading the source code and associated documentation, and on the software development guidelines, may be directed to <a class="reference external" href="http://www.cmascenter.org/" rel="noreferrer" target="_blank"><a class="reference external" href="http://www.cmascenter.org" rel="noreferrer" target="_blank">http://www.cmascenter.org <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a> <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a>.</p>
<p>Based on the insights gained from the testing and archiving of a development version of the model such as CMAQ-MADRID, CMAS recom­mends the following steps as the minimum level of coding and testing practices to be adopted by developers wishing to contribute code to the public CMAQ archive:</p>
<ol class="arabic simple">
<li><p>To make the best use of the CMAQ features in developing new code, the developer should review the coding conventions that are provided in the previous sections of this chapter. Also see <a class="reference external" href="http://www.epa.gov/asmdnerl/CMAQ/CMAQscienceDoc.html" rel="noreferrer" target="_blank">the EPA CMAQ Science Document <svg version="1.1" width="1.0em" height="1.0em" viewBox="0 0 16 16" aria-hidden="true" style="display: inline-block; vertical-align: middle; fill: currentColor;"><path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2Zm6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1Z"></path></svg></a>].</p></li>
<li><p>New code should be built using the current operational CMAQ version as a template whenever possible. This will facilitate consistency in coding practices, including naming conventions, in-line documentation, and the specification of compile time versus run-time parameters.</p></li>
<li><p>Before submitting source code to the CMAS Center, the developer should verify that the code is consistent with the operational CMAQ version from which it was built, especially in the use of common INCLUDE files (such as horizontal and vertical grid definition files) and run-time parameter settings. Mixing code from different operational versions of the CMAQ model within the same development code version can lead to problems in using the generalized CMAQ scripts.</p></li>
<li><p>Comprehensive documentation or other references to peer-reviewed literature should be provided for any new science algorithms include in the source code.</p></li>
<li><p>The developer must document the computational platform used for the testing, including type and speed of the processor(s), the compiler version used, and CPU usage. It is recommended that developers use any combination of the above for testing code intended for release through the CMAS Center, to facilitate benchmarking and portability testing by CMAS staff. Any documentation on potential differences in model outputs between different computing platforms would be useful for end-users who may not be able to duplicate the platform on which the model was initially developed and tested. To this end, code testing and documentation of test results by developers, using more than one platform if available, are highly desirable.</p></li>
<li><p>The developer should provide all input data for the test case so that interested users may attempt to run the code and reproduce the results on their own platforms.</p></li>
<li><p>It is recommended that benchmark results from the testing be provided for at least one 5‑day simulation. Shorter simulations do not provide adequate results from which to discern model trends beyond the spin-up period.</p></li>
<li><p>When making incremental changes to model science, the developer should provide documentation of the results, including (a) the results for all variables that show a deviation of greater than 1.0e10<sup>‑6</sup> ppm for the gas-phase species or 1.0e10<sup>‑4</sup> µg m<sup>‑3</sup> for the particulate species from the base model results for the same case, (b) an analysis of what was done to understand these differences, and (c) conclusions of the analysis.</p></li>
<li><p>Note that more than one simulation may be necessary to adequately demonstrate seasonal or regional biases, if any, in the results. It is also understood that with models still under development, the analysis may not resolve all differences from the operational model results. It is recommended that these unresolved issues also be documented.</p></li>
</ol>
<p>Model developers are also recommended to check the CMAS website to see if there are any additional guidelines that have been recommended since the first set listed above.</p>
</section>
<section id="references-for-chapter-11-code-management">
<h2>References for Chapter 11: Code Management<a class="headerlink" href="#references-for-chapter-11-code-management" title="Link to this heading">#</a></h2>
<p>Fine, S. S., W. T. Smith, D. Hwang, T. L. Turner, 1998: Improving model development with configuration management, IEEE Computational Science and Engineering, 5(1, Ja-Mr), 56-65.</p>
<p>J. Rumbaugh, M. Blaha, W. Premerlani, F. Eddy, and W. Lorensen, 1991: Object-Oriented Modeling and Design, Prentice Hall</p>
<p>Young, J. O.,’’ ‘’Integration of Science Code into Models-3, 1999. In <em>Science Algorithms of the EPA Models-3 Community Multiscale Air Quality (CMAQ) Modeling System</em>, D. W. Byun and J. K. S. Ching (ed.), EPA/600/R-99/030, U. S. EPA, Research Triangle Park, NC.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-code-management">Source Code Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-need-for-a-configuration-management-tool">The need for a configuration-management tool</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choice-of-a-configuration-management-tool">Choice of a configuration-management tool</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#git-explained">git Explained</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#guidelines-for-developing-new-cmaq-source-code">Guidelines for Developing New CMAQ Source Code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#object-oriented-concepts">Object-oriented concepts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#global-name-data-table">Global name data table</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thin-interface">Thin Interface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-guidelines">Coding guidelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#documentation-guidelines">Documentation guidelines</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#science-process-code-template">Science process code template</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compiling-cmaq-with-new-source-code">Compiling CMAQ with New Source Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#guidelines-to-writing-shell-scripts-for-cmaq">Guidelines to Writing Shell Scripts for CMAQ</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-and-distribution-of-development-source-code">Testing and Distribution of Development Source Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references-for-chapter-11-code-management">References for Chapter 11: Code Management</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>