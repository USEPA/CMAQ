# Pre-processors

## [MCIP](https://github.com/USEPA/CMAQ/tree/main/PREP/mcip)

### Updates to Calculation of XORIG/YORIG for Some Lambert Domains (MCIP, Two-Way WRF-CMAQ, and Combine)
[Tanya Spero](mailto:spero.tanya@epa.gov), U.S. Environmental Protection Agency    
**Type of update**: Bug Fix  
**Release Version/Date**: CMAQv5.5

**Description**:  The calculations of XORIG and YORIG in MCIP, _aqprep_ (in the two-way WRF-CMAQ), and _combine_ had constraints that were introduced to facilitate matching the MM5 and WRF domains in Lambert conformal projection for initial testing. Those constraints were only used when Lambert conformal projection was used **and** the user specified a reference latitude via the MCIP namelist. The algorithm that was used to align the XORIG and YORIG adjusted for real-number disagreements in converting the gridding parameters between WRF and CMAQ by using an algorithm that constrained the XORIG and YORIG to increments of 500 meters. However, that algorithm did not work as intended when the horizontal grid spacing was not in increments of 1 km. In this update, the algorithm in MCIP and _aqprep_ was modified to constrain XORIG and YORIG to increments of 5 meters.

The original algorithm was removed from _combine_, and it was replaced with logic that allows for concurrent processing of WRF and CMAQ output. The expected use case in _combine_ for WRF and CMAQ is to process meteorological output from WRF only when MCIP is not available, i.e., from the two-way WRF-CMAQ runs. Thus, the updates in _combine_ restrict the concurrent processing WRF and CMAQ to cases when those models have concentric domains with a symmetric perimeter removed from WRF to form the CMAQ domain. In addition, _combine_ now requires domains with a horizontal grid spacing >400 meters because we have not tested the rigor of the algorithm below that scale.

**Significance and Impact**: Changes to XORIG and YORIG from this algorithm _only_ occur for domains that use Lambert conformal projection **and** a user-specified reference latitude. The algorithm in MCIP and _aqprep_ that previously had been used to set XORIG and YORIG at factors of 500 meters is not appropriate when the horizontal grid spacing is not evenly divisible by 1 km (e.g., 4.25 km, 1.33 km, 0.444 km). The constraint is now set to 5 meters in those codes. That constraint and logic was not appropriate for _combine_, so a new constraint was introduced to only allow WRF and CMAQ data to be processed together when the domains are concentric, such as from the two-way WRF-CMAQ model. There is no impact from these coding changes for many domains, but XORIG and YORIG could be adjusted for domains with very small horizontal grid spacings (e.g., 1.33 km and 0.444 km). In some cases in those fine-scale domains, the changes to XORIG and YORIG could shift coastlines and some observations and point-source emissions to a neighboring grid cell. If there are changes to XORIG and YORIG from using this algorithm for a given domain, then those changes would be reflected in the GRIDDESC and in the I/O API headers of files generated by the CMAQ system. Changes to XORIG and YORIG could introduce inconsistencies in the headers of files processed with different releases of CMAQ, so there could be some challenges in mixing and matching those files for simulations and analysis.

|Merge Commit | Internal record|
|:------:|:-------:|
|[Merge for PR#1090](https://github.com/USEPA/CMAQ/commit/c426d91df2f905110a0c6a131217c49482869bf3) | [PR#1090](https://github.com/USEPA/CMAQ_Dev/pull/1090)  |   


### Removed Superfluous Open/Close Couplet to Read WRF Files in MCIP
[Tanya Spero](mailto:spero.tanya@epa.gov), U.S. Environmental Protection Agency     
**Type of update**: Efficiency  
**Release Version/Date**: CMAQv5.5

**Description**: Updated rdwrfem.f90 in MCIP to remove redundant open/close of netCDF files.

**Significance and Impact**: This change improves efficiency and does not change the simulation results. The change reduces runtime of MCIP by ~25-30% per day for hourly WRF output in daily files on the benchmark domain. Reductions in runtime become negligible for large computational domains.

|Merge Commit | Internal record|
|:------:|:-------:|
|[Merge for PR#1097](https://github.com/USEPA/CMAQ/commit/7319ff625dd70a88eb43124a3989574fc0f8551f) | [PR#1097](https://github.com/USEPA/CMAQ_Dev/pull/1097)  |    

### Updated MCIP Metadata for WRF Physics Beyond WRFv4.1
[Tanya Spero](mailto:spero.tanya@epa.gov), U.S. Environmental Protection Agency   
**Type of update**: Metadata Update   
**Release Version/Date**: CMAQv5.5  

**Description**: The global header information (i.e., metadata) in the MCIP output files lists the high-level WRF physics options that were used in the WRF simulation processed by MCIP. The text interpretation of the WRF token values (collected from the WRF metadata in its output header) is based on a translation in MCIP that is performed in the subroutine wrfemopts.f90. That subroutine had not been updated since WRFv4.1 was released, and additional WRF physics options have been implemented between then and the release of WRFv4.5.2. This change to MCIP provides updates to the cross-reference listing to improve accuracy of metadata for newer WRF physics options.

**Significance and Impact**: This change to MCIP does not affect the numerical calculations. However, it improves the accuracy of the metadata in the MCIP header when newer WRF physics options (implemented after WRFv4.1) are exercised and subsequently processed through MCIP.

**References**: [WRF Users Guide for WRFv4.5](https://www2.mmm.ucar.edu/wrf/users/wrf_users_guide/build/html/physics.html)

|Merge Commit | Internal record|
|:------:|:-------:|
|[Merge for PR#1098](https://github.com/USEPA/CMAQ/commit/a93487cc482cebfa9d43bb2b82bec8f45a63942c) | [PR#1098](https://github.com/USEPA/CMAQ_Dev/pull/1098)  |    

### Additional MCIP release notes can be found under the [DOCS/MCIP](https://github.com/USEPA/CMAQ/tree/main/PREP/mcip/docs) folder. 

## [ICON](https://github.com/USEPA/CMAQ/tree/main/PREP/icon)
 No changes were made to ICON in CMAQv5.5.

## [BCON](https://github.com/USEPA/CMAQ/tree/main/PREP/bcon)

### Improved IC/BC species mappings for CRACMM  
[Havala Pye](mailto:pye.havala@epa.gov) and [Christian Hogrefe](mailto:hogrefe.christian@epa.gov), U.S. Environmental Protection Agency   
**Type of update**: Bug fix  
**Release Version/Date**: CMAQv5.5  

**Description**: The species definition file mapping carbon bond-based mechanism species to CRACMM species located at PREP/bcon/map2mech/SpecDef_*.txt was updated to improve consistency across mechanisms and reduce unnecessary mapping. Mapping of tracers/species that do not contribute meaningfully to mass (TOLRO2, XYLRO2, AH3OP, IEPOXP) were removed. Mapping across monoterpene and isoprene systems was updated. These updates were implemented for CRACMM1 and were carried forward to CRACMM2 as part of CRACMM2 development.   

Additionally, the mapping of carbon bond species SVSQT was updated for both CRACMM1 and CRACMM2. Previously, SVSQT was mapped to a species name that was not a valid CRACMM species. This resulted in a loss of mass for SVSQT (which is expected to have small concentrations at the model boundaries). This species mapping has been updated in CMAQv5.5 to correctly map SVSQT for both CRACMM1 and CRACMM2. This is the only change in species mappings in CRACMM1 between CMAQv5.4 and CMAQv5.5. Additional mapping updates for CRACMM2 support the renaming of aromatic species XYL (xylenes and other aromatic species) and EBZ (ethylbenzene), the addition of species STY (styrene), and the addition of methane emissions tracer species ECH4.   

**Significance and Impact**: Improves consistency in how species map across mechanisms. Minor changes to model predictions are expected. This file is not recommended for mapping emissions between mechanisms as the representation of fresh emissions is more variable between mechanisms than the representation of processed emissions. Updates to CRACMM2 species mappings support species that are new or that have been modified in CRACMM2.

|Merge Commit | Internal record|
|:------:|:-------:|
|[Merge for PR#958](https://github.com/USEPA/CMAQ/commit/97f04d8143da5f70d20a76384494657411c77416) | [PR#958](https://github.com/USEPA/CMAQ_Dev/pull/958)  |
|[Merge for PR#1095](https://github.com/USEPA/CMAQ/commit/5c9f5441b24efd94ad6be5ad939c5f6fc8af2980) | [PR#1095](https://github.com/USEPA/CMAQ_Dev/pull/1095)  |
|[Merge for PR#1133](https://github.com/USEPA/CMAQ/commit/ee260009f408e528f187260edb6bcd51ad58f75d) | [PR#1133](https://github.com/USEPA/CMAQ_Dev/pull/1133)  |


## [Create OMI](https://github.com/USEPA/CMAQ/tree/main/PREP/create_omi) 
[William T. Hutzell](mailto:hutzell.bill@epa.gov), U.S. Environmental Protection Agency     
**Type of update**: Bug fix and Scripts Update         
**Release Version/Date**: CMAQv5.4    

**Description**:  A bug fix and script enhancement was made. The bug fix corrects format statements used to write the ASCII output file. The error and its fix were identified in a [CMAS Forum post](https://forum.cmascenter.org/t/some-questions-about-using-different-resolution-omi-file-in-cmaq5-3-2/2569/4). When the latitude and longitude resolution is greater than 360X360 degrees, the format descriptors are too small and cause the output lines to wrap around themselves. The error causes the total ozone column to be incorrectly calculated in CCTM and produce bad values of photolysis frequencies from the inline build option. The bad values do not exist in the repositories version of the OMI data file under CCTM/src/phot/inline.
 The script enhancement revises create_omi's build and run scripts so they function as similar scripts for ICON and BCON tools.      

**Significance and Impact**:  If the simulation uses an OMI data file created with lat/long resolution greater than 360X360 degrees, CCTM will calculate and use bad values of photolysis frequencies.

|Merge Commit | Internal record|
|:------:|:-------:|
|[Merge for PR#779](https://github.com/USEPA/CMAQ/commit/095ea1e8e40e320786045701a8d0d1cd5b0b4b41) | [PR#779](https://github.com/USEPA/CMAQ_Dev/pull/779)  |

